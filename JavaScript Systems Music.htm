<!DOCTYPE html>
<!-- saved from url=(0110)http://teropa.info/blog/2016/07/28/javascript-systems-music.html#brian-enoambient-1-music-for-airports-2-11978 -->
<html class=" js no-touch svg inlinesvg svgclippaths no-ie8compat" lang="en"><script>(function main() {
    // Create enabled event
    function fireEnabledEvent() {
        // If gli exists, then we are already present and shouldn't do anything
        if (!window.gli) {
            setTimeout(function () {
                var enabledEvent = document.createEvent("Event");
                enabledEvent.initEvent("WebGLEnabledEvent", true, true);
                document.dispatchEvent(enabledEvent);
            }, 0);
        } else {
            //console.log("WebGL Inspector already embedded on the page - disabling extension");
        }
    };

    // Grab the path root from the extension
    document.addEventListener("WebGLInspectorReadyEvent", function (e) {
        var pathElement = document.getElementById("__webglpathroot");
        if (window["gliloader"]) {
            gliloader.pathRoot = pathElement.innerText;
        } else {
            // TODO: more?
            window.gliCssUrl = pathElement.innerText + "gli.all.css";
        }
    }, false);

    // Rewrite getContext to snoop for webgl
    var originalGetContext = HTMLCanvasElement.prototype.getContext;
    if (!HTMLCanvasElement.prototype.getContextRaw) {
        HTMLCanvasElement.prototype.getContextRaw = originalGetContext;
    }
    HTMLCanvasElement.prototype.getContext = function () {
        var ignoreCanvas = this.internalInspectorSurface;
        if (ignoreCanvas) {
            return originalGetContext.apply(this, arguments);
        }

        var result = originalGetContext.apply(this, arguments);
        if (result == null) {
            return null;
        }

        var contextNames = ["moz-webgl", "webkit-3d", "experimental-webgl", "webgl", "3d"];
        var requestingWebGL = contextNames.indexOf(arguments[0]) != -1;
        if (requestingWebGL) {
            // Page is requesting a WebGL context!
            fireEnabledEvent(this);

            // If we are injected, inspect this context
            if (window.gli) {
                if (gli.host.inspectContext) {
                    // TODO: pull options from extension
                    result = gli.host.inspectContext(this, result);
                    // NOTE: execute in a timeout so that if the dom is not yet
                    // loaded this won't error out.
                    window.setTimeout(function() {
                        var hostUI = new gli.host.HostUI(result);
                        result.hostUI = hostUI; // just so we can access it later for debugging
                    }, 0);
                }
            }
        }

        return result;
    };
})();</script><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="description" content="Tero Parviainen">
    <meta name="copyright" content="Tero Parviainen">
    <link type="text/plain" rel="author" href="http://teropa.info/humans.txt">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta http-equiv="cleartype" content="on">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    

    <title>JavaScript Systems Music</title>

    
      <meta property="og:title" content="JavaScript Systems Music">
      <meta property="og:type" content="article">
      
        <meta property="og:image" content="http://teropa.info/images/javascript-systems-music-cover.png">
      
      <meta property="article:author" content="https://www.facebook.com/terop">
    

    
      <link rel="stylesheet" href="./JavaScript Systems Music_files/obsidian.min.css">
      <link href="./JavaScript Systems Music_files/font-awesome.min.css" media="screen" rel="stylesheet" type="text/css">
    
    <link rel="stylesheet" type="text/css" href="./JavaScript Systems Music_files/fonts.css">
    <link rel="stylesheet" href="./JavaScript Systems Music_files/css" type="text/css">
    <link href="./JavaScript Systems Music_files/application.css" media="screen" rel="stylesheet" type="text/css">
    

    

    
      <script src="./JavaScript Systems Music_files/modernizr.js" type="text/javascript"></script>
    

    
  <style type="text/css">/*! nouislider - 8.5.1 - 2016-04-24 16:00:30 */


.noUi-target,.noUi-target *{-webkit-touch-callout:none;-webkit-user-select:none;-ms-touch-action:none;touch-action:none;-ms-user-select:none;-moz-user-select:none;user-select:none;-moz-box-sizing:border-box;box-sizing:border-box}.noUi-target{position:relative;direction:ltr}.noUi-base{width:100%;height:100%;position:relative;z-index:1}.noUi-origin{position:absolute;right:0;top:0;left:0;bottom:0}.noUi-handle{position:relative;z-index:1}.noUi-stacking .noUi-handle{z-index:10}.noUi-state-tap .noUi-origin{-webkit-transition:left .3s,top .3s;transition:left .3s,top .3s}.noUi-state-drag *{cursor:inherit!important}.noUi-base,.noUi-handle{-webkit-transform:translate3d(0,0,0);transform:translate3d(0,0,0)}.noUi-horizontal{height:18px}.noUi-horizontal .noUi-handle{width:34px;height:28px;left:-17px;top:-6px}.noUi-vertical{width:18px}.noUi-vertical .noUi-handle{width:28px;height:34px;left:-6px;top:-17px}.noUi-background{background:#FAFAFA;box-shadow:inset 0 1px 1px #f0f0f0}.noUi-connect{background:#3FB8AF;box-shadow:inset 0 0 3px rgba(51,51,51,.45);-webkit-transition:background 450ms;transition:background 450ms}.noUi-origin{border-radius:2px}.noUi-target{border-radius:4px;border:1px solid #D3D3D3;box-shadow:inset 0 1px 1px #F0F0F0,0 3px 6px -5px #BBB}.noUi-target.noUi-connect{box-shadow:inset 0 0 3px rgba(51,51,51,.45),0 3px 6px -5px #BBB}.noUi-draggable{cursor:w-resize}.noUi-vertical .noUi-draggable{cursor:n-resize}.noUi-handle{border:1px solid #D9D9D9;border-radius:3px;background:#FFF;cursor:default;box-shadow:inset 0 0 1px #FFF,inset 0 1px 7px #EBEBEB,0 3px 6px -3px #BBB}.noUi-active{box-shadow:inset 0 0 1px #FFF,inset 0 1px 7px #DDD,0 3px 6px -3px #BBB}.noUi-handle:after,.noUi-handle:before{content:"";display:block;position:absolute;height:14px;width:1px;background:#E8E7E6;left:14px;top:6px}.noUi-handle:after{left:17px}.noUi-vertical .noUi-handle:after,.noUi-vertical .noUi-handle:before{width:14px;height:1px;left:6px;top:14px}.noUi-vertical .noUi-handle:after{top:17px}[disabled] .noUi-connect,[disabled].noUi-connect{background:#B8B8B8}[disabled] .noUi-handle,[disabled].noUi-origin{cursor:not-allowed}.noUi-pips,.noUi-pips *{-moz-box-sizing:border-box;box-sizing:border-box}.noUi-pips{position:absolute;color:#999}.noUi-value{position:absolute;text-align:center}.noUi-value-sub{color:#ccc;font-size:10px}.noUi-marker{position:absolute;background:#CCC}.noUi-marker-large,.noUi-marker-sub{background:#AAA}.noUi-pips-horizontal{padding:10px 0;height:80px;top:100%;left:0;width:100%}.noUi-value-horizontal{-webkit-transform:translate3d(-50%,50%,0);transform:translate3d(-50%,50%,0)}.noUi-marker-horizontal.noUi-marker{margin-left:-1px;width:2px;height:5px}.noUi-marker-horizontal.noUi-marker-sub{height:10px}.noUi-marker-horizontal.noUi-marker-large{height:15px}.noUi-pips-vertical{padding:0 10px;height:100%;top:0;left:100%}.noUi-value-vertical{-webkit-transform:translate3d(0,-50%,0);transform:translate3d(0,-50%,0);padding-left:25px}.noUi-marker-vertical.noUi-marker{width:5px;height:2px;margin-top:-1px}.noUi-marker-vertical.noUi-marker-sub{width:10px}.noUi-marker-vertical.noUi-marker-large{width:15px}.noUi-tooltip{display:block;position:absolute;border:1px solid #D9D9D9;border-radius:3px;background:#fff;padding:5px;text-align:center}.noUi-horizontal .noUi-handle-lower .noUi-tooltip{top:-32px}.noUi-horizontal .noUi-handle-upper .noUi-tooltip{bottom:-32px}.noUi-vertical .noUi-handle-lower .noUi-tooltip{left:120%}.noUi-vertical .noUi-handle-upper .noUi-tooltip{right:120%}</style><style type="text/css">.eq .slider-wrapper {
  /* Float the wrappers so the slider will render side by side */
  float: left;
}
.eq .slider {
  /* Give some horizontal space around each slider */
  margin: auto 6px;
  /* Set the slider height */
  height: 150px;
}
/* Make the frequency labels smaller and lighter */
.eq label {
  color: #777;
  display: block;
  font-size: 0.5em;
  text-align: center;
  margin-bottom: 2em;
}</style><script type="text/javascript" async="" src="./JavaScript Systems Music_files/embed.js"></script><script type="text/javascript" charset="utf-8" async="" src="./JavaScript Systems Music_files/button.80ba267f37d7093ec36703643939b173.js"></script></head>
  <body>
      <div class="cover-wrap">
  <div class="cover with-image">
    
      <div class="img">
        <div class="bg" style="background-image: url(/images/tape-recorder.JPG)">
        </div>
      </div>
    
    <div class="">
      <h1 style="
                 
                 ">
          
          JavaScript Systems Music
      </h1>
    </div>
    
      <div class="narrow-content">
        <h2 style="">Learning Web Audio by Recreating The Works of Steve Reich and Brian Eno</h2>
      </div>
    
    </div>
  </div>


<article>
  
  <div class="time narrow-content">
    Posted on <time datetime="2016-07-28">Thursday Jul 28, 2016</time>
    by <a href="http://teropa.info/">Tero Parviainen</a> (<a href="https://twitter.com/teropa">@teropa</a>)
  </div>

  <div class="body">
    <p class="intro">
<strong>Systems music</strong> is an idea that explores the following question: What if we could, instead of making music, design <em>systems that generate music for us</em>?
</p>

<p class="intro">This idea has animated artists and composers for a long time and emerges in new forms whenever new technologies are adopted in music-making.</p>

<p class="intro">In the 1960s and 70s there was a particularly fruitful period. People like Steve Reich, Terry Riley, Pauline Oliveros, and Brian Eno designed systems that resulted in many landmark works of minimal and ambient music. They worked with the cutting edge technologies of the time: Magnetic tape recorders, loops, and delays.</p>

<p class="intro">Today our technological opportunities for making systems music are broader than ever. Thanks to computers and software, they're virtually endless. But to me, there is one platform that's particularly exciting from this perspective: <a href="https://webaudio.github.io/web-audio-api/">Web Audio</a>. Here we have a technology that combines audio synthesis and processing capabilities with a general purpose programming language: JavaScript. It is a platform that's available <em>everywhere</em> — or at least <a href="http://caniuse.com/#feat=audio-api">we're getting there</a>. If we make a musical system for Web Audio, any computer or smartphone in the world can run it.</p>

<p class="intro">
With Web Audio we can do something Reich, Riley, Oliveros, and Eno could not do all those decades ago: They could only share <em>some of the output</em> of their systems by recording them. We can share the <em>system itself</em>. Thanks to the unique power of the web platform, all we need to do is send a URL.
</p>

<p class="intro">
In this guide we'll explore some of the history of systems music and the possibilities of making musical systems with Web Audio and JavaScript. We'll pay homage to three seminal systems pieces by examining and attempting to recreate them: "<a href="https://en.wikipedia.org/wiki/It%27s_Gonna_Rain">It's Gonna Rain</a>" by Steve Reich, "<a href="https://en.wikipedia.org/wiki/Discreet_Music">Discreet Music</a>" by Brian Eno, and "<a href="https://en.wikipedia.org/wiki/Ambient_1:_Music_for_Airports">Ambient 1: Music for Airports</a>", also by Brian Eno.
</p>

<p></p>

<h2 id="table-of-contents">Table of Contents</h2>

<ul>
<li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#is-this-for-me">"Is This for Me?"</a></li>
<li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#how-to-read-this-guide">How to Read This Guide</a></li>
<li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#the-tools-youll-need">The Tools You'll Need</a></li>
<li>
  <a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#steve-reichits-gonna-rain1965">Steve Reich - It's Gonna Rain (1965)</a>
  <ul>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#setting-up-itsgonnarain-js">Setting Up <code>itsgonnarain.js</code></a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#loading-a-sound-file">Loading A Sound File</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#playing-the-sound">Playing The Sound</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#looping-the-sound">Looping The Sound</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#how-phase-music-works">How Phase Music Works</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#setting-up-the-second-loop">Setting up The Second Loop</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#adding-stereo-panning">Adding Stereo Panning</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#putting-it-together-adding-phase-shifting">Putting It Together: Adding Phase Shifting</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#exploring-variations-on-its-gonna-rain">Exploring Variations on It's Gonna Rain</a></li>
  </ul>
</li>
<li>
  <a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#brian-enoambient-1-music-for-airports-2-11978">Brian Eno - Ambient 1: Music for Airports, 2/1 (1978)</a>
  <ul>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#the-notes-and-intervals-in-music-for-airports">The Notes and Intervals in Music for Airports</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#setting-up-musicforairports-js">Setting up <code>musicforairports.js</code></a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#obtaining-samples-to-play">Obtaining Samples to Play</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#building-a-simple-sampler">Building a Simple Sampler</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#a-system-of-loops">A System of Loops</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#playing-extended-loops">Playing Extended Loops</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#adding-reverb">Adding Reverb</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#putting-it-together-launching-the-loops">Putting It Together: Launching the Loops</a></li>
    <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#exploring-variations-on-music-for-airports">Exploring Variations on Music for Airports</a></li>
  </ul>
</li>
<li>
    <a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#brian-enodiscreet-music1975">Brian Eno - Discreet Music (1975)</a>
    <ul>
      <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#setting-up-discreetmusic-js">Setting up <code>discreetmusic.js</code></a></li>
      <li>
        <a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#synthesizing-the-sound-inputs">Synthesizing the Sound Inputs</a>
        <ul>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#setting-up-a-monophonic-synth-with-a-sawtooth-wave">Setting up a Monophonic Synth with a Sawtooth Wave</a></li>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#filtering-the-wave">Filtering the Wave</a></li>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#tweaking-the-amplitude-envelope">Tweaking the Amplitude Envelope</a></li>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#bringing-in-a-second-oscillator">Bringing in a Second Oscillator</a></li>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#emulating-tape-wow-with-vibrato">Emulating Tape Wow with Vibrato</a></li>
        </ul>
      </li>
      <li>
        <a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#understanding-timing-in-tone-js">Understanding Timing in Tone.js</a>
        <ul>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#transport-time">Transport Time</a></li>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#musical-timing">Musical Timing</a></li>
        </ul>
      </li>
      <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#sequencing-the-synth-loops">Sequencing the Synth Loops</a></li>
      <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#adding-echo">Adding Echo</a></li>
      <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#adding-tape-delay-with-frippertronics">Adding Tape Delay with Frippertronics</a></li>
      <li>
        <a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#controlling-timbre-with-a-graphic-equalizer">Controlling Timbre with a Graphic Equalizer</a>
        <ul>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#setting-up-the-equalizer-filters">Setting up the Equalizer Filters</a></li>
          <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#building-the-equalizer-control-ui">Building the Equalizer Control UI</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="http://teropa.info/blog/2016/07/28/javascript-systems-music.html#going-forward">Going Forward</a></li>
</ul>

<h2 id="is-this-for-me">"Is This for Me?"</h2>

<p>This guide is targeted for people who know some JavaScript and are interested in making music with it.</p>

<p>We'll be using <a href="https://babeljs.io/docs/learn-es2015/">ES2015</a> JavaScript and knowing at least some of it will make it a lot easier to follow along. However, we won't be doing anything hugely sophisticated, so advanced knowledge is not required.</p>

<p>You don't have to be a musician or an expert in music theory to follow this guide. I'm neither of those things. I'm figuring things out as I go and it's perfectly fine if you do too. I believe that this kind of stuff is well within reach for anyone who knows a bit of programming, and you can have a lot of fun with it even if you aren't a musician.</p>

<p>One thing that definitely won't hurt though is an interest in experimental music! This will get weird at times.</p>

<h2 id="how-to-read-this-guide">How to Read This Guide</h2>

<p>The guide is divided into three chapters, one for each of the musical pieces we'll study and recreate:</p>

<ul>
<li>In "It's Gonna Rain" we'll get acquainted with the Web Audio API and playing sounds with it.</li>
<li>In "Music for Airports" we'll learn more details about playing sample-based music and implementing audio processing effects such as reverb.</li>
<li>In "Discreet Music" we'll study audio synthesis and sequencing with the <a href="https://github.com/Tonejs/Tone.js">Tone.js</a> library and build a more elaborate effects graph.</li>
</ul>

<p>Each chapter stands on its own, so you can just pick one and read it. However, I will refer to previous chapters from time to time and I recommend working through the whole guide in order. This is especially true if you haven't used the Web Audio API before.</p>

<p>You'll get the most out of the guide if you write your own version of the code every step of the way. This will also allow you to further experiment with the systems. But you don't have to do that if you don't want to. I've set things up so that you can hear and see everything right on this page.</p>

<h2 id="the-tools-youll-need">The Tools You'll Need</h2>

<p>For running the experiments you'll need a web browser that supports ES2015 JavaScript and <a href="http://caniuse.com/#feat=audio-api">the Web Audio API</a>. The latest versions of Chrome and Firefox will work fine, as will Safari 10 (currently <a href="https://developer.apple.com/safari/download/">in beta</a>). MS Edge should be OK too, but Internet Explorer will not work.</p>

<p>If you also want to code along, you need a couple of other things:</p>

<ul>
<li>A code editor, such as <a href="https://atom.io/">Atom</a> or <a href="https://code.visualstudio.com/">Visual Studio Code</a>, for authoring the code.</li>
<li>An installation of <a href="https://nodejs.org/en/">Node.js</a>. We'll use it to run a local web server.</li>
</ul>

<h2 id="steve-reichits-gonna-rain1965"><div class="piece"><div class="artist">Steve Reich</div><div class="title">It's Gonna Rain</div><div class="year">1965</div></div></h2>

<blockquote cite="./JavaScript Systems Music_files/reich.html">
  Performing and listening to a gradual musical process resembles:
  pulling back a swing, releasing it, and observing it gradually come to rest;
  turning over an hour glass and watching the sand slowly run through the bottom;
  placing your feet in the sand by the ocean's edge and watching, feeling, and listening to the waves gradually bury them.
  <footer>Steve Reich, <a href="./JavaScript Systems Music_files/reich.html">Music as a Gradual Process, 1968</a></footer>
</blockquote>

<p>The first piece we're going to explore takes us back to the mid-1960s. This was a time right after the Cuban Missile Crisis, when the end of the world by nuclear annihilation did not seem all that implausible.</p>

<p>In this tense atmosphere, young American composer <a href="https://en.wikipedia.org/wiki/Steve_Reich">Steve Reich</a> was experimenting with using <a href="https://en.wikipedia.org/wiki/Reel-to-reel_audio_tape_recording">reel-to-reel magnetic tape recorders</a> for the purpose of making music.</p>

<figure>
  <img src="./JavaScript Systems Music_files/tape-recorder-orig.JPG">
  <figcaption>
    A reel-to-reel tape recorder. Photo: <a href="https://en.wikipedia.org/wiki/Reel-to-reel_audio_tape_recording#/media/File:UniversumUNAM47.JPG">Alejandro Linares Garcia</a>.
  </figcaption>
</figure>

<p>One of the exciting new possibilities of this technology was that you could <em>record your own sounds</em> and then play them back. Reich was using this possibility to make field recordings. In 1965 he happened upon San Francisco's Union Square, where a Pentecostal preacher called Brother Walter was bellowing about the end of the world.</p>

<div class="vid">
  <iframe width="100%" height="315" src="./JavaScript Systems Music_files/uUTRS0iW7oE.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>From this tape Reich would construct what is considered to be his first major work and one of the definitive pieces of American minimal music: "It's Gonna Rain".</p>

<p>As you listen to it, I'd like you to pay particularly close attention to the movement that begins around the two minute mark and lasts for about six minutes. This is the part produced by the process that we're about to examine.</p>

<div class="vid">
  <iframe width="100%" height="315" src="./JavaScript Systems Music_files/vugqRAX7xQE.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>Now, this is not exactly easy listening. It gets pretty intense. Notwithstanding the pigeon drummer, it even challenges most people's conception of what "music" even means. This is basically just looped human speech, isn't it?</p>

<p>To me, what this piece seems to be saying is <em>"we're going to take this subsecond apocalyptic sound clip and we're going to listen the shit out of it"</em>. And as we listen, the clip starts shifting and layering on top of itself. The words disappear and it all just becomes pure sound. Even though no new sonic information is being introduced, you keep noticing new things all the time — things that were there all along but you just hadn't payed attention to. Until, at the end, the words re-emerge again and we're back where we started and not quite sure what just happened.</p>

<p>To say I actually <em>enjoy</em> listening to this piece would probably be stretching it. It wouldn't be among the records I'd take with me on a desert island. But it is certainly <em>fascinating</em> and kind of hypnotic too. If you allow it to, it does evoke a certain kind of mental atmosphere.</p>

<blockquote cite="./JavaScript Systems Music_files/Jonathan_Cott_interview.html">
  All music to some degree invites people to bring their own emotional life to it. My early pieces do that in an extreme form, but, paradoxically, they do so through a very organized process, and it’s precisely the impersonality of that process that invites this very engaged psychological reaction.
  <footer>Steve Reich, <a href="./JavaScript Systems Music_files/Jonathan_Cott_interview.html">1996</a></footer>
</blockquote>

<p>Because of the simplicity of this piece, it's a great way for us to begin exploring Web Audio. So let's see how we might be able to reconstruct it in a web browser.</p>

<h3 id="setting-up-itsgonnarain-js">Setting up <code>itsgonnarain.js</code></h3>

<div class="aside">
  <p>
    The source code for this project is <a href="https://github.com/teropa/itsgonnarain.js">available on GitHub</a>.
  </p>
</div>

<p>To host our JavaScript version of It's Gonna Rain, we're going to need a bit of HTML and a bit of JavaScript. Create a new directory for this project and add two files into it:</p>

<ul>
<li><code>itsgonnarain/</code>

<ul>
<li><code>index.html</code></li>
<li><code>itsgonnarain.js</code></li>
</ul></li>
</ul>

<p>Then set the contents of <code>index.html</code> as follows:</p>

<pre class="hljs "><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.rawgit.com/mohayonao/web-audio-api-shim/master/build/web-audio-api-shim.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"itsgonnarain.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</pre>

<pre class="ws-hack"></pre>

<p>This is a very simple HTML document that just loads a couple of JavaScript files to the page:</p>

<ul>
<li>The <a href="http://mohayonao.github.io/web-audio-api-shim/">web-audio-api-shim</a> library, which irons out some browser inconsistencies with the Web Audio API so that we don't have to deal with them.</li>
<li>A polyfill for the <a href="https://developer.mozilla.org/en/docs/Web/API/Fetch_API">Fetch API</a>, which also isn't fully supported across all browsers yet.</li>
<li>The file that will host our own code, <code>itsgonnarain.js</code>.</li>
</ul>

<div class="aside">
<p>
  We're not going to use an ES2015 transpiler in these code examples, and will just rely on native browser support of the latest JavaScript features. If you want to share your work with the wider world, you'll definitely also want to transpile your code with a tool like <a href="https://babeljs.io/">Babel</a>.
</p>
</div>

<p>Also add some content to the <code>itsgonnarain.js</code> file:</p>

<pre class="hljs "><span class="hljs-built_in">console</span>.log(<span class="hljs-string">"It's gonna rain"</span>);
</pre>

<p>This will print a message to the browser's development console. It'll give us a chance to check that everything is working once we load up the page in a web browser. But before we can do that, we'll need to serve it up with a web server. Open up a command line and install the <a href="https://www.npmjs.com/package/lite-server">lite-server</a> Node.js package:</p>

<pre class="hljs ">npm install -g lite-server
</pre>

<p>The <code>npm</code> command comes with Node.js, so if it isn't working for you make sure you have <a href="https://nodejs.org/en/download/">Node installed</a>.</p>

<p>We now have a package we can use to spin up a web server, and we can do so by running the following command from inside the <code>itsgonnarain</code> project directory:</p>

<pre class="hljs ">lite-server
</pre>

<p>We'll keep the server running throughout the project. You should now be able to open <a href="http://localhost:3000/">http://localhost:3000</a> in a web browser to load the project (or it may already have opened automatically for you). It'll just be a blank page, but if you go and open the browser's <a href="https://developers.google.com/web/tools/chrome-devtools/?hl=en">developer tools</a> you should see the <code>It's gonna rain</code> message in the console. We're ready to start playing some sounds!</p>

<p><img src="./JavaScript Systems Music_files/itsgonnarain-console-message.png">
</p><div class="aside">
  <p>
    I recommend always keeping the developer console open while working on the project. If something goes wrong with the code, this is where the browser will tell you about it.
  </p>
</div><p></p>

<h3 id="loading-a-sound-file">Loading A Sound File</h3>

<p>What we're going to do first is simply play a sound sample on our webpage. Before we can play it though, we'll need to <em>load</em> it.</p>

<p>What I did for my version was to take an MP3 file of the Reich piece and extract a short clip from the first 15 seconds or so. Unfortunately I can't give you that clip to download, but you can easily obtain it (it's on e.g. <a href="https://www.amazon.com/gp/product/B00122MTEU/ref=dm_ws_ap_tlw_trk3">Amazon</a> or  <a href="https://itunes.apple.com/us/album/early-works/id79577208">iTunes</a>). Or you can use some other piece of audio that you think would be interesting to use as raw material - it's entirely up to you!</p>

<p>Whatever audio you use, make sure it's in a <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Supported_media_formats">format that web browsers can understand</a>  (.wav, .mp3, .ogg, etc.) and then place the file inside the project directory.</p>

<p>Once we have an audio file, we can add some JavaScript code to load it in:</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs ">fetch(<span class="hljs-string">'itsgonnarain.mp3'</span>)
  .then(response =&gt; response.arrayBuffer())
  .then(arrayBuffer =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Received'</span>, arrayBuffer))
  .catch(e =&gt; <span class="hljs-built_in">console</span>.error(e));
</pre>

<p>Here we are using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">Fetch API</a> to send a request for the audio file over the network (which in this case will just go to our local web server). The file will eventually be received back from the server, and what <code>fetch()</code> returns back to us is a <a href="http://www.html5rocks.com/en/tutorials/es6/promises/">Promise</a> object that will give us a chance to react when that happens.</p>

<p>What we do with the Promise is call its <code>.then()</code> method and supply it with a callback function we want to run when the response comes in. In the callback we invoke the <code>arrayBuffer()</code> method of the response, letting it know that we want to have the incoming data as a binary <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a> object.</p>

<p>Then we have to wait a bit more to actually receive all that data, so we get back <em>another</em> Promise object. This one will get fulfilled when the browser has finished receiving every last bit of the (binary) data. Into this second Promise we attach a callback function that simply logs the resulting ArrayBuffer into the developer console. We also include a <code>catch</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch">rejection handler</a>, which will log any errors that might occur during this whole process, so that if something goes wrong it'll also be shown in the developer console.</p>

<p>You should now see this message:</p>

<p><img src="./JavaScript Systems Music_files/itsgonnarain-console-message-arraybuffer.png">
We now have the raw MP3 data loaded to our page.</p>

<h3 id="playing-the-sound">Playing The Sound</h3>

<p>We still have to do one more thing before we can play the MP3 data we now have. We have to <em>decode</em> it into a playable form. This is where we bring in the Web Audio API, which has the facilities for doing that.</p>

<p>With Web Audio, everything begins with something called an <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext">AudioContext</a>. This is an object that handles all the audio processing we're going to do and internally manages any communication with the audio hardware and the resources associated with it. Before we do anything else, we need to create one of those <code>AudioContext</code>s. We'll be using it for many things, but right now we're going to call its <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/decodeAudioData">decodeAudioData</a> method to turn our MP3 ArrayBuffer into a decoded <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer">AudioBuffer</a>:</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs "><span class="codeblock-highlight"><span class="hljs-keyword">let</span> audioContext = <span class="hljs-keyword">new</span> AudioContext();</span>

fetch(<span class="hljs-string">'itsgonnarain.mp3'</span>)
  .then(response =&gt; response.arrayBuffer())
  <span class="codeblock-highlight">.then(arrayBuffer =&gt; audioContext.decodeAudioData(arrayBuffer))</span>
  <span class="codeblock-highlight">.then(audioBuffer =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Decoded'</span>, audioBuffer))</span>
  .catch(e =&gt; <span class="hljs-built_in">console</span>.error(e));
</pre>

<p>As we see here, <code>decodeAudioData</code> actually <em>also</em> returns a Promise instead of giving us the audio data right away. That's because the data may take a while to decode and the browser does it in the background, letting us get on with other business in the meantime. So what we now have is a chain of <em>three</em> nested Promises. After the last one we do our console logging. The message in the developer console should show that we have about 14 seconds of stereo audio data – or whatever the duration of your sound file happens to be.</p>

<p><img src="./JavaScript Systems Music_files/itsgonnarain-console-message-audiobuffer.png">
This is something we can now play, so let's go right ahead and do that. We're going to use the AudioContext again, this time to create something called a <em>buffer source</em>. This is an object that knows how to play back an AudioBuffer. We give it the buffer we have, connect it, and start it. The result is that we can hear the sound play from the browser window – our equivalent of hitting the play button on Reich's tape recorder.</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs has-player player-itsgonnarain"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> audioContext = <span class="hljs-keyword">new</span> AudioContext();

fetch(<span class="hljs-string">'itsgonnarain.mp3'</span>)
  .then(response =&gt; response.arrayBuffer())
  .then(arrayBuffer =&gt; audioContext.decodeAudioData(arrayBuffer))
  .then(audioBuffer =&gt; <span class="codeblock-highlight">{
    <span class="hljs-keyword">let</span> sourceNode = audioContext.createBufferSource();
    sourceNode.buffer = audioBuffer;
    sourceNode.connect(audioContext.destination);
    sourceNode.start();
  }</span>)
  .catch(e =&gt; <span class="hljs-built_in">console</span>.error(e));
</pre>

<p>What we've done here is set up our very first <strong>audio-processing graph</strong>, which consists of just two nodes, one connected to the next:</p>

<ul>
<li>An <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode">AudioBufferSourceNode</a> that reads in the AudioBuffer data and streams it to other nodes.</li>
<li>The AudioContext's built-in <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioDestinationNode">AudioDestinationNode</a>, which makes the sound audible on the machine's speakers.</li>
</ul>

<figure class="diagram" style="max-width: 450px">
  <img src="./JavaScript Systems Music_files/webaudio-graph-itsgonnarain.png">
  <figcaption>Basic Web Audio graph with a single source</figcaption>
</figure>

<p>In general, all audio processing with the Web Audio API happens with such graphs, through which audio signals flow, starting from source nodes and ending up in destination nodes, possibly going through a number of intermediate nodes. These graphs may contain different kinds of nodes that generate, transform, measure, or play audio. We'll soon be constructing more elaborate graphs, but this is all you need if you simply want to play back a sound.</p>

<h3 id="looping-the-sound">Looping The Sound</h3>

<p>What we have so far plays the audio file once and then stops. What we really want to do though to begin recreating the magic of "It's Gonna Rain" is make it <em>loop</em> over and over again.</p>

<figure>
  <div style="float: right; max-width: 300px;">
    <img src="./JavaScript Systems Music_files/tape-to-loop.png">
  </div>
</figure>

<p>Steve Reich was using magnetic tape, which in its usual configuration spools from one reel to the other. But there's a brilliant hack, <a href="http://www.factmag.com/2016/02/23/pierre-schaeffer-guide/">pioneered by Pierre Schaeffer</a>,   that  allows you to circumvent this process: You can <a href="https://en.wikipedia.org/wiki/Tape_loop">splice the tape into a loop</a> which gets you an infinitely repeating sample with a duration of a few seconds or less.</p>

<p>For Reich, as for anyone working with tape, this meant a <a href="https://www.youtube.com/watch?v=sZ91rEhoOaM">laborious process</a> of finding the right bit of tape, cutting it up and gluing it back together again. For us, it's much, much easier. This is because the <code>AudioBufferSourceNode</code> interface we're using happens to have a <code>loop</code> flag we can just set to <code>true</code>:</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs has-player player-itsgonnarain-looped-full"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> sourceNode = audioContext.createBufferSource();
sourceNode.buffer = audioBuffer;
<span class="codeblock-highlight">sourceNode.loop = <span class="hljs-literal">true</span>;</span>
sourceNode.connect(audioContext.destination);
sourceNode.start();
</pre>

<p>The effect of this is that the <em>whole sample</em> loops round and round forever.</p>

<p>We should still do the equivalent of cutting up the little piece that says "It's Gonna Rain" and loop just that bit. We could go into an audio editor and create an <code>.mp3</code> file that only contains that part, but we don't actually need to. <code>AudioBufferSourceNode</code> has attributes called <code>loopStart</code> and <code>loopEnd</code> for controlling this. They allow setting the offsets, in seconds, of where the loop should start and end. With some trial and error you can find good values for them:</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs has-player player-itsgonnarain-looped-specific-startzero"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> sourceNode = audioContext.createBufferSource();
sourceNode.buffer = audioBuffer;
sourceNode.loop = <span class="hljs-literal">true</span>;
<span class="codeblock-highlight">sourceNode.loopStart = <span class="hljs-number">2.98</span>;
sourceNode.loopEnd = <span class="hljs-number">3.80</span>;</span>
sourceNode.connect(audioContext.destination);
sourceNode.start();
</pre>

<p>With these settings, the sample still starts playing from the very beginning and then gets "stuck" looping between 2.98 and 3.80, resulting in a loop with a duration of 0.82 seconds.</p>

<p>If we <em>only</em> want to play the looping part, we should also <em>begin</em> playing the sample from the loop start offset, which we can do by giving that same value to the <code>start()</code> method of the buffer source:</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs has-player player-itsgonnarain-looped-specific"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> sourceNode = audioContext.createBufferSource();
sourceNode.buffer = audioBuffer;
sourceNode.loop = <span class="hljs-literal">true</span>;
sourceNode.loopStart = <span class="hljs-number">2.98</span>;
sourceNode.loopEnd = <span class="hljs-number">3.80</span>;
sourceNode.connect(audioContext.destination);
sourceNode.start(<span class="codeblock-highlight"><span class="hljs-number">0</span>, <span class="hljs-number">2.98</span></span>);
</pre>

<p>The <code>start()</code> method optionally <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/start">takes up to three arguments</a>, and we're giving two of them here:</p>

<ul>
<li><em>When</em> to start playing. We want to start playing immediately, so we set it to zero. This is also the default but since we want to provide that second argument, we also need to come up with something for the first.</li>
<li>The <em>offset</em> at which to start playing the buffer. We set it to 2.98 - the beginning of our loop.</li>
</ul>

<h3 id="how-phase-music-works">How Phase Music Works</h3>

<p>And now we come to the real technical trick that underlies "It's Gonna Rain": What we are hearing are two identical tape loops playing at the same time. There's one in the left ear and one in the right. But one of those loops is running <em>ever so slightly faster than the other</em>.</p>

<p>The difference is so small you don't even notice it at first, but after a while it amounts to a <em>phase shift</em> between the two loops that keeps growing bigger and bigger as time goes by. First it sounds like there's an echo. Then the echo transforms into a repeating effect, and then it builds into a series of strange combinations of sounds as different parts of the sample overlap with others. At the halfway point the loops start to approach each other again, and we go back through repetition and echo to unison.</p>

<p>Brian Eno has likened this process to a <a href="https://en.wikipedia.org/wiki/Moir%C3%A9_pattern">moiré pattern</a>, where two simple identical geometrical patterns are superimposed to give rise to something much more complex than the original.</p>

<div class="moire-container">
  <div class="moire-1"></div>
  <div class="moire-2"></div>
  <div class="vid">
    <iframe width="100%" height="315" src="./JavaScript Systems Music_files/q0DQRfm0uL8.html" frameborder="0" allowfullscreen=""></iframe>
  </div>
</div>

<style type="text/css">
  .moire-container {
    padding: 20px 0;
    margin-bottom: 1.5em;
    position: relative;
    overflow: hidden;
  }
  .moire-1, .moire-2 {
    position: absolute;
    left: -100px;
    right: -100px;
    top: -100px;
    bottom: -100px;
    opacity: 0.4;
  }
  .moire-1 {
    background-color: #111;
    background-image: linear-gradient(90deg, transparent 50%, white 50%);
    background-size: 3px 3px;
  }
  @keyframes moire {
    0 { transform: rotate(0); }
    25% { transform: rotate(10deg); }
    50% { transform: rotate(0); }
    75% { transform: rotate(-10deg); }
  }
  .moire-2 {
    background-color: #111;
    background-image: linear-gradient(90deg, transparent 50%, white 50%);
    background-size: 3px 3px;
    animation: moire 60s linear 0s infinite;
  }
  .moire-container .vid {
    position: relative;
    z-index: 1;
  }
  .moire-container iframe {
    margin-bottom: 0;
  }
</style>

<p>It's a remarkably simple trick compared to the apparent complexity of what you actually hear. And from a 0.82 second loop we get six minutes of music. That's pretty good return on investment!</p>

<p>This is called <a href="https://en.wikipedia.org/wiki/Phase_music">phase music</a>, which is a kind of systems music. One way to think about it is that Reich, as the author of the piece, did not write a <em>score</em> for it. He just set the inputs and parameters for a phase-shifting <em>process</em> which he would then execute, generating the music.</p>

<blockquote cite="./JavaScript Systems Music_files/reich.html">
  Though I may have the pleasure of discovering musical processes and composing the musical material to run through them, once the process is set up and loaded it runs by itself.
  <footer>Steve Reich, <a href="./JavaScript Systems Music_files/reich.html">Music as a Gradual Process</a></footer>
</blockquote>

<h3 id="setting-up-the-second-loop">Setting up The Second Loop</h3>

<p>To reproduce the phase-shifting process, we're going to need another instance of the "It's gonna rain" sound loop. Let's extract the initialization of our source node into a new function called <code>startLoop</code>, which we can then call twice. Two source nodes that both play the same <code>AudioBuffer</code> are created and started:</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs has-player player-itsgonnarain-two"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> audioContext = <span class="hljs-keyword">new</span> AudioContext();

<span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startLoop</span>(<span class="hljs-params">audioBuffer</span>) </span>{
  <span class="hljs-keyword">let</span> sourceNode = audioContext.createBufferSource();
  sourceNode.buffer = audioBuffer;
  sourceNode.loop = <span class="hljs-literal">true</span>;
  sourceNode.loopStart = <span class="hljs-number">2.98</span>;
  sourceNode.loopEnd = <span class="hljs-number">3.80</span>;
  sourceNode.connect(audioContext.destination);
  sourceNode.start(<span class="hljs-number">0</span>, <span class="hljs-number">2.98</span>);
}</span>

fetch(<span class="hljs-string">'itsgonnarain.mp3'</span>)
  .then(response =&gt; response.arrayBuffer())
  .then(arrayBuffer =&gt; audioContext.decodeAudioData(arrayBuffer))
  .then(audioBuffer =&gt; {
    <span class="codeblock-highlight">startLoop(audioBuffer);</span>
    <span class="codeblock-highlight">startLoop(audioBuffer);</span>
  })
  .catch(e =&gt; <span class="hljs-built_in">console</span>.error(e));
</pre>

<p>The only effect of doing this so far is that the sound we hear becomes louder. There are now two sources playing the loop in unison, which amps up the volume.</p>

<figure class="diagram" style="max-width: 450px">
  <img src="./JavaScript Systems Music_files/webaudio-graph-itsgonnarain-two-sources.png">
  <figcaption>Web Audio graph with two looped sources.</figcaption>
</figure>

<h3 id="adding-stereo-panning">Adding Stereo Panning</h3>

<p>In Reich's piece the two loops are playing in separate stereo channels, one in your left ear and one in the right. We should do the same.</p>

<p>The <code>AudioBufferSourceNode</code> interface has no property for controlling this. Instead there's a more general purpose solution for it in the Web Audio API, which is to add specialized <a href="https://developer.mozilla.org/en-US/docs/Web/API/StereoPannerNode">StereoPannerNode</a>s to the audio graph.  They can be used to pan their incoming audio signal to any point in the stereo field.</p>

<p><code>StereoPannerNode</code> has a <code>pan</code> attribute that can be set to a number between <code>-1</code> (all the way to the left) and <code>1</code> (all the way to the right), with the default being <code>0</code> (in the center). We set up our loops so that one is fully on the left and the other on the right:</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs has-player player-itsgonnarain-two-panned"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> audioContext = <span class="hljs-keyword">new</span> AudioContext();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startLoop</span>(<span class="hljs-params">audioBuffer</span></span><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-params">, pan = 0</span></span></span><span class="hljs-function">) </span>{
  <span class="hljs-keyword">let</span> sourceNode = audioContext.createBufferSource();
  <span class="codeblock-highlight"><span class="hljs-keyword">let</span> pannerNode = audioContext.createStereoPanner();</span>

  sourceNode.buffer = audioBuffer;
  sourceNode.loop = <span class="hljs-literal">true</span>;
  sourceNode.loopStart = <span class="hljs-number">2.98</span>;
  sourceNode.loopEnd = <span class="hljs-number">3.80</span>;
  <span class="codeblock-highlight">pannerNode.pan.value = pan;</span>

  <span class="codeblock-highlight">sourceNode.connect(pannerNode);</span>
  <span class="codeblock-highlight">pannerNode.connect(audioContext.destination);</span>

  sourceNode.start(<span class="hljs-number">0</span>, <span class="hljs-number">2.98</span>);
}

fetch(<span class="hljs-string">'itsgonnarain.mp3'</span>)
  .then(response =&gt; response.arrayBuffer())
  .then(arrayBuffer =&gt; audioContext.decodeAudioData(arrayBuffer))
  .then(audioBuffer =&gt; {
    startLoop(audioBuffer<span class="codeblock-highlight">, <span class="hljs-number">-1</span></span>);
    startLoop(audioBuffer<span class="codeblock-highlight">, <span class="hljs-number">1</span></span>);
  })
  .catch(e =&gt; <span class="hljs-built_in">console</span>.error(e));
</pre>

<p>We are no longer connecting the source nodes directly to the <code>AudioContext</code> destination. We connect them to the panner nodes, and then the panner nodes to the destination. The audio signals flow through the panners:</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-itsgonnarain-panned.png">
  <figcaption>Web audio graph with two loops panned to different ends of the stereo field.</figcaption>
</figure>

<h3 id="putting-it-together-adding-phase-shifting">Putting It Together: Adding Phase Shifting</h3>

<p>Finally we're ready introduce the phase shifting. This is done so that one of the loops plays slightly faster than the other. The difference should be so small that you don't perceive it at first, but large enough so that a noticeable phase shift starts accumulating over time.</p>

<p>The playback speed of an <code>AudioBufferSourceNode</code> can be set using the <code>playbackRate</code> attribute. The default value is <code>1</code> and setting it to something else makes it go slower or faster. For example, setting it to <code>2</code>  doubles the playback speed, also halving the duration in the process.</p>

<p>For our purposes, I've found setting a value around <code>1.002</code> for one loop and keeping the other as <code>1</code> to work  well. When the original loop is <code>0.82</code> seconds long, the second one thus becomes <code>0.82 / 1.002 ≈ 0.818</code> seconds long.</p>

<div class="codeblock-banner">itsgonnarain.js</div>

<pre class="hljs has-player player-itsgonnarain-two-panned-phased"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> audioContext = <span class="hljs-keyword">new</span> AudioContext();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startLoop</span>(<span class="hljs-params">audioBuffer, pan = 0</span></span><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-params">, rate = 1</span></span></span><span class="hljs-function">) </span>{
  <span class="hljs-keyword">let</span> sourceNode = audioContext.createBufferSource();
  <span class="hljs-keyword">let</span> pannerNode = audioContext.createStereoPanner();

  sourceNode.buffer = audioBuffer;
  sourceNode.loop = <span class="hljs-literal">true</span>;
  sourceNode.loopStart = <span class="hljs-number">2.98</span>;
  sourceNode.loopEnd = <span class="hljs-number">3.80</span>;
  <span class="codeblock-highlight">sourceNode.playbackRate.value = rate;</span>
  pannerNode.pan.value = pan;

  sourceNode.connect(pannerNode);
  pannerNode.connect(audioContext.destination);

  sourceNode.start(<span class="hljs-number">0</span>, <span class="hljs-number">2.98</span>);
}

fetch(<span class="hljs-string">'itsgonnarain.mp3'</span>)
  .then(response =&gt; response.arrayBuffer())
  .then(arrayBuffer =&gt; audioContext.decodeAudioData(arrayBuffer))
  .then(audioBuffer =&gt; {
    startLoop(audioBuffer, <span class="hljs-number">-1</span>);
    startLoop(audioBuffer, <span class="hljs-number">1</span><span class="codeblock-highlight">, <span class="hljs-number">1.002</span></span>);
  })
  .catch(e =&gt; <span class="hljs-built_in">console</span>.error(e));
</pre>

<p>And with that, we have "It's Gonna Rain"!</p>

<div class="player-area">
  <h4>"It's Gonna Rain"</h4>
  <div class="phasing player-large" style="display: flex; justify-content: space-between">
    <canvas class="spinners startstop" width="150" height="150" style="cursor: pointer"></canvas>
    <canvas class="canvas" width="1000" height="150" style="width: calc(100% - 160px)"></canvas>
  </div>
</div>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-itsgonnarain-panned-phased.png">
  <figcaption>Web audio graph with two loops, panned and with phasing.</figcaption>
</figure>

<h3 id="exploring-variations-on-its-gonna-rain">Exploring Variations on It's Gonna Rain</h3>

<p>There's a lot of exploration we can do around the process we've set up. Here's a couple of ideas you can try to see what happens:</p>

<ul>
<li>Try different playback rates. How much faster can you make one of the loops compared to the other before it turns from "phasing" to something else?</li>
<li>Set different values for panning. Does the piece sound different if you only partially pan the loops, or don't pan them at all? How about dynamic panning that changes over time? (There are several <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioParam">methods in the Web Audio API for gradually ramping</a> parameters like <code>pan</code> or <code>playbackRate</code> up or down)</li>
</ul>

<p>Another route of exploration is using different <em>sound sources</em> for the piece. You can try looping different parts of <code>itsgonnarain.mp3</code>, some of them shorter, some of them longer. Why not also try sourcing samples from audio you've found from the Internet or recorded yourself? You could try speech samples or even pieces of songs. The same process can result in wildly different results given different inputs. Here are some loops I've made:</p>

<div class="player-area">
  <h5>"Ways to Survive" (Kendrick Lamar)</h5>
  <div class="phasing-variation-2 player" style="display: flex; justify-content: space-between">
    <canvas class="spinners startstop" width="100" height="100" style="cursor: pointer"></canvas>
    <canvas class="canvas" width="1000" height="100" style="width: calc(100% - 110px)"></canvas>
  </div>

  <h5>"Rhythm Was Generating" (Patti Smith)</h5>
  <div class="phasing-variation-1 player" style="display: flex; justify-content: space-between">
    <canvas class="spinners startstop" width="100" height="100" style="cursor: pointer"></canvas>
    <canvas class="canvas" width="1000" height="100" style="width: calc(100% - 110px)"></canvas>
  </div>

  <h5>"Does It Make Common Sense?" (Laurie Anderson)</h5>
  <div class="phasing-variation-3 player" style="display: flex; justify-content: space-between">
    <canvas class="spinners startstop" width="100" height="100" style="cursor: pointer"></canvas>
    <canvas class="canvas" width="1000" height="100" style="width: calc(100% - 110px)"></canvas>
  </div>
</div>

<p>Steve Reich himself would later develop the tape phasing technique further in the 1966 piece <a href="https://www.youtube.com/watch?v=g0WVh1D0N50">Come Out</a>, whose civil rights theme is still <a href="http://pitchfork.com/features/article/9886-blood-and-echoes-the-story-of-come-out-steve-reichs-civil-rights-era-masterpiece/">unsettlingly pertinent 50 years later</a>.</p>

<p>Reich also took the tape phasing idea and applied it to live performance in <a href="https://www.youtube.com/watch?v=uQihuaedvSU">Piano Phase</a> in 1967 and <a href="https://www.youtube.com/watch?v=doJk4yPwJDk">Drumming</a> in 1970. <a href="http://www.chenalexander.com/">Alexander Chen</a> has made a great <a href="http://www.chenalexander.com/Piano-Phase">Web Audio version of Piano Phase</a>.</p>

<h2 id="brian-enoambient-1-music-for-airports-2-11978"><div class="piece"><div class="artist">Brian Eno</div><div class="title">Ambient 1: Music for Airports, 2/1</div><div class="year">1978</div></div></h2>

<blockquote cite="./JavaScript Systems Music_files/eno_qa_full">
  Once I started working with generative music in the 1970s, I was flirting with ideas of making a kind of endless music — not like a record that you'd put on and which would play for a while and finish. I like the idea of a kind of eternal music, but I didn't want it to be eternally repetitive, either. I wanted it to be eternally changing.
  <footer>Brian Eno, <a href="./JavaScript Systems Music_files/eno_qa_full">2007</a></footer>
</blockquote>

<p>Prior to the mid-1970s, Brian Eno was mainly known for his art rock bona fides, first as a member of Roxy Music and then <a href="https://www.youtube.com/watch?v=PAqc54h9YU8">as a solo artist</a>. But this would soon change. Eno was  interested in the experimental techniques of John Cage, Terry Riley, and Steve Reich. He was – and still is – also something of a tech geek. He was an early user of synthesizers and would later become a big proponent of the idea of <a href="http://music.hyperreal.org/artists/brian_eno/interviews/downbeat79.htm">the whole music studio as a compositional tool</a>.</p>

<p>In 1975 Eno got into an accident. He was overrun by a speeding London taxi and was left hospitalized. During his time in the hospital something happened that led him to the conceptualization of <a href="https://en.wikipedia.org/wiki/Ambient_music">"ambient music"</a> – a term everyone is by now familiar with.</p>

<div class="vid">
<iframe width="100%" height="315" src="./JavaScript Systems Music_files/oMNBnakSd2Q.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>Now, <a href="https://en.wikipedia.org/wiki/Ambient_1:_Music_for_Airports">Ambient 1: Music for Airports</a> was not the first record Eno made as a result of this epiphany. That would have been "Discreet Music" a couple of years earlier, something that we're going to look into in the next chapter. But "Music for Airports" has a track on it that is very directly influenced by both the concept and the execution of Steve Reich's tape pieces. It's the second track on side A.</p>

<div class="vid">
<iframe width="100%" height="315" src="./JavaScript Systems Music_files/0R-mscnjI14.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>As a musical experience, this is clearly nothing like "It's Gonna Rain" though. Instead of a frantic loop of apocalyptic sermonizing, we're treated with gentle waves of vocal harmonies. It actually kind of sounds like music in the traditional sense!</p>

<p>But even though the results are very different, there are very close similarities in the underlying <em>systems</em> that produce the music.</p>

<h3 id="the-notes-and-intervals-in-music-for-airports">The Notes and Intervals in Music for Airports</h3>

<p>Before we discuss the system though, let's discuss the inputs.</p>

<p>The raw materials Eno used on this track are seven different "aahhh" sounds (<a href="./JavaScript Systems Music_files/eno1.html">"sung by three women and myself"</a>). Each one of those sounds is on a different pitch.</p>

<p>In terms of musical notes, what we are hearing are F, A-flat, and from the next octave C, D-flat, E-flat, F, and A-flat. These, <a href="https://monoskop.org/images/f/f1/Tamm_Eric_Brian_Eno_His_Music_and_the_Vertical_Color_of_Sound.pdf">I'm told</a>, together form "a D-flat major seventh chord with an added ninth". It's really quite beautiful:</p>

<table>
  <tbody><tr>
    <th><button play-notes="F3">F</button></th>
    <th><button play-notes="Ab3">A<sub>♭</sub></button></th>
    <th><button play-notes="C4">C'</button></th>
    <th><button play-notes="Db4">D<sub>♭</sub>'</button></th>
    <th><button play-notes="Eb4">E<sub>♭</sub>'</button></th>
    <th><button play-notes="F4">F'</button></th>
    <th><button play-notes="Ab4">A<sub>♭</sub>'</button></th>
  </tr>
</tbody></table>

<p>This chord evokes a kind of reflective mood, which is very common throughout Eno's ambient work. You can get an idea of what he was going for in this interview clip (I like the sound of "well, if you die, it doesn't really matter"):</p>

<div class="vid">
<iframe width="100%" height="315" src="./JavaScript Systems Music_files/ykJg-vE3k-E.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>The note selection is also important because of the way the notes may combine. We'll be feeding these individual notes into a kind of generative system, and we will have little control over which combinations of two or more notes may occur. Any succession of notes might be played back to back forming a <em>melody</em>, or on top of each other forming a <em>harmony</em>.</p>

<p>Here are all the possible two note intervals in this chord:</p>

<table>
  <tbody><tr>
    <th></th>
    <th>A<sub>♭</sub></th>
    <th>C'</th>
    <th>D<sub>♭</sub>'</th>
    <th>E<sub>♭</sub>'</th>
    <th>F'</th>
    <th>A<sub>♭</sub>'</th>
  </tr>
  <tr>
    <th>F</th>
    <td><button play-notes="F3,Ab3">▶</button></td>
    <td><button play-notes="F3,C4">▶</button></td>
    <td><button play-notes="F3,Db4">▶</button></td>
    <td><button play-notes="F3,Eb4">▶</button></td>
    <td><button play-notes="F3,F4">▶</button></td>
    <td><button play-notes="F3,Ab4">▶</button></td>
  </tr>
  <tr>
    <th>A<sub>♭</sub></th>
    <td></td>
    <td><button play-notes="Ab3,C4">▶</button></td>
    <td><button play-notes="Ab3,Db4">▶</button></td>
    <td><button play-notes="Ab3,Eb4">▶</button></td>
    <td><button play-notes="Ab3,F4">▶</button></td>
    <td><button play-notes="Ab3,Ab4">▶</button></td>
  </tr>
  <tr>
    <th>C'</th>
    <td></td>
    <td></td>
    <td><button play-notes="C4,Db4">▶</button></td>
    <td><button play-notes="C4,Eb4">▶</button></td>
    <td><button play-notes="C4,F4">▶</button></td>
    <td><button play-notes="C4,Ab4">▶</button></td>
  </tr>
  <tr>
    <th>D<sub>♭</sub>'</th>
    <td></td>
    <td></td>
    <td></td>
    <td><button play-notes="Db4,Eb4">▶</button></td>
    <td><button play-notes="Db4,F4">▶</button></td>
    <td><button play-notes="Db4,Ab4">▶</button></td>
  </tr>
  <tr>
    <th>E<sub>♭</sub>'</th>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td><button play-notes="Eb4,F4">▶</button></td>
    <td><button play-notes="Eb4,Ab4">▶</button></td>
  </tr>
  <tr>
    <th>F'</th>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
    <td><button play-notes="F4,Ab4">▶</button></td>
  </tr>
</tbody></table>

<p>Among all these intervals, there's just one that's <a href="https://en.wikibooks.org/wiki/Music_Theory/Consonance_and_Dissonance">sharply dissonant</a> (a minor second) and sounds a bit off. Can you hear it? However, since there's just one and it'll thus not occur very frequently, it'll only serve to add a bit of spice to the music. Looks like whatever the system may throw at us will generally sound pretty good.</p>

<h3 id="setting-up-musicforairports-js">Setting up <code>musicforairports.js</code></h3>

<div class="aside">
  <p>
    The source code for this project is <a href="https://github.com/teropa/musicforairports.js">available on GitHub</a>.
  </p>
</div>

<p>With this background knowledge, we're ready to start writing our own little version of this piece. Let's begin by setting up the project. The basic structure will be very similar to what we did with "It's Gonna Rain".</p>

<p>Create a new directory and add two files to it:</p>

<ul>
<li><code>musicforairports/</code>

<ul>
<li><code>index.html</code></li>
<li><code>musicforairports.js</code></li>
</ul></li>
</ul>

<p>Then set the contents of <code>index.html</code> as follows:</p>

<pre class="hljs "><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.rawgit.com/mohayonao/web-audio-api-shim/master/build/web-audio-api-shim.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"musicforairports.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</pre>

<pre class="ws-hack"></pre>

<p>We can leave the JavaScript file empty for now. If we just launch the web server from this directory, we're all set to start hacking:</p>

<pre class="hljs ">lite-server
</pre>

<h3 id="obtaining-samples-to-play">Obtaining Samples to Play</h3>

<p>We're going to build a system that plays sounds based on the musical chord that we just heard. But we haven't really discussed <em>what</em> sounds those are actually going to be.</p>

<p>Eno used a set of samples based on voices he'd recorded himself. We have little hope of reproducing those voices exactly, so we're not going to even try. We can use readymade samples obtained from the Internet instead. Specifically, we're going to use samples from the freely available <a href="http://sso.mattiaswestlund.net/">Sonatina Symphonic Orchestra</a> sound bank. This is a very nice sampling of the sounds of individual instruments in a symphonic orchestra - violins, brass instruments, percussion, etc.</p>

<p>Go ahead and download and then unpack the <a href="http://sso.mattiaswestlund.net/download.html">Sonatina ZIP archive</a>. It's pretty large so it might take a while to transfer and you'll need space for it. Then move or copy the <code>Samples</code> directory to the <code>musicforairports</code> project.</p>

<ul>
<li><code>musicforairports/</code>

<ul>
<li><code>index.html</code></li>
<li><code>musicforairports.js</code></li>
<li><code>Samples</code>

<ul>
<li><code>1st Violins</code>

<ul>
<li><code>1st-violins-piz-rr1-a#3.wav</code></li>
<li>etc.</li>
</ul></li>
<li>etc.</li>
</ul></li>
</ul></li>
</ul>

<p>Basically, we want to set things up so that we'll be able to load any of the samples into our JavaScript code, which means they need to be inside a directory we're serving using the <code>lite-server</code>.</p>

<div class="aside">
  <p>
    If you're feeling adventurous, there's a lot of more experimentation you can do around sample selection, beyond the sounds found in the Sonatina library. You could:
    </p><ul>
      <li>Find other samples online, in places like <a href="https://freesound.org/">freesound.org</a>.</li>
      <li>Generate samples from GarageBand or some other piece of software or equipment.</li>
      <li>Record your own voice or a musical instrument.</li>
      <li>Synthesize the sound, as we do in the next chapter.</li>
    </ul>
  <p></p>
</div>

<h3 id="building-a-simple-sampler">Building a Simple Sampler</h3>

<p>We now have a sample library and we should write some code that will allow us to play different musical notes using the various musical instruments in that library. In other words, we're going to write a primitive JavaScript <a href="https://en.wikipedia.org/wiki/Sampler_(musical_instrument)">sampler</a>.</p>

<p>If you look into the various subdirectories under <code>Samples</code> you'll notice that there are many <code>.wav</code> files for each musical instrument, for various notes. But there's a problem: There aren't samples for <em>every</em> musical note. For example, looking at the alto flute, we've got samples for A<sub>#</sub>, C<sub>#</sub>, E, and G on three different octaves, but that's only four notes per octave. There are twelve semitones in an octave, so eight out of twelve are missing!</p>

<p>This is not really a problem though, and it's a pretty common occurrence in sample libraries. An obvious reason for this is preserving storage and bandwidth: You may have noticed that the Sonatina library is already half a gigabyte in size. If it included all the notes of all the instruments, that number could easily triple.</p>

<p>What we will do for each note that is missing a sample, is to find the <em>nearest note that does have a sample</em> and <a href="https://en.wikipedia.org/wiki/Pitch_shift">pitch-shift</a> that sample to the new note. This technique for "filling in the blanks" is commonly used by samplers.</p>

<p>Let's look at the samples for the grand piano - an instrument I find fits well with this piece. It has samples on about seven octaves, a few in each octave. If we visualize the whole <a href="https://en.wikipedia.org/wiki/Chromatic_scale">chromatic scale</a> for octaves 4, 5, and 6, we see what we have and what's missing:</p>

<table>
  <tbody><tr>
    <th>C4</th>
    <td class="missing-note">C<sub>#</sub>4 D<sub>♭</sub>4</td>
    <td class="missing-note">D4</td>
    <th>D<sub>#</sub>4 E<sub>♭</sub>4</th>
    <td class="missing-note">E4</td>
    <td class="missing-note">F4
    </td><th>F<sub>#</sub>4 G<sub>♭</sub>4</th>
    <td class="missing-note">G4</td>
    <td class="missing-note">G<sub>#</sub>4 A<sub>♭</sub>4</td>
    <th>A4</th>
    <td class="missing-note">A<sub>#</sub>4 B<sub>♭</sub>4</td>
    <td class="missing-note">B4</td>
  </tr>
  <tr>
    <th>C5</th>
    <td class="missing-note">C<sub>#</sub>5 D<sub>♭</sub>5</td>
    <td class="missing-note">D5</td>
    <th>E<sub>#</sub>5 E<sub>♭</sub>5</th>
    <td class="missing-note">E5</td>
    <td class="missing-note">F5
    </td><th>F<sub>#</sub>5 G<sub>♭</sub>5</th>
    <td class="missing-note">G5</td>
    <td class="missing-note">G<sub>#</sub>5 A<sub>♭</sub>6</td>
    <th>A5</th>
    <td class="missing-note">A<sub>#</sub>5 B<sub>♭</sub>5</td>
    <td class="missing-note">B5</td>
  </tr>
  <tr>
    <th>C6</th>
    <td class="missing-note">C<sub>#</sub>6 D<sub>♭</sub>6</td>
    <td class="missing-note">D6</td>
    <th>D<sub>#</sub>6 E<sub>♭</sub>6</th>
    <td class="missing-note">E6</td>
    <td class="missing-note">F6</td>
    <th>F<sub>#</sub>6 G<sub>♭</sub>6</th>
    <td class="missing-note">G6</td>
    <td class="missing-note">G<sub>#</sub>6 A<sub>♭</sub>7</td>
    <th>A6</th>
    <td class="missing-note">A<sub>#</sub>6 B<sub>♭</sub>6</td>
    <td class="missing-note">B6</td>
  </tr>
</tbody></table>

<style type="text/css">
.missing-note {
  color: #aaa;
  text-align: center;
}
</style>

<p>What our sampler should do is find for each of these notes the nearest note that has a sample. When we do that we have the <em>keymap</em> for this instrument:</p>

<table>
  <tbody><tr>
    <th class="zone-1">C4</th>
    <td class="missing-note zone-1">C<sub>#</sub>4 D<sub>♭</sub>4</td>
    <td class="missing-note zone-2">D4</td>
    <th class="zone-2">D<sub>#</sub>4 E<sub>♭</sub>4</th>
    <td class="missing-note zone-2">E4</td>
    <td class="missing-note zone-3">F4
    </td><th class="zone-3">F<sub>#</sub>4 G<sub>♭</sub>4</th>
    <td class="missing-note zone-3">G4</td>
    <td class="missing-note zone-4">G<sub>#</sub>4 A<sub>♭</sub>5</td>
    <th class="zone-4">A4</th>
    <td class="missing-note zone-4">A<sub>#</sub>4 B<sub>♭</sub>4</td>
    <td class="missing-note zone-5">B4</td>
  </tr>
  <tr>
    <th class="zone-5">C5</th>
    <td class="missing-note zone-5">C<sub>#</sub>5 D<sub>♭</sub>5</td>
    <td class="missing-note zone-6">D5</td>
    <th class="zone-6">E<sub>#</sub>5 E<sub>♭</sub>5</th>
    <td class="missing-note zone-6">E5</td>
    <td class="missing-note zone-7">F5
    </td><th class="zone-7">F<sub>#</sub>5 G<sub>♭</sub>5</th>
    <td class="missing-note zone-7">G5</td>
    <td class="missing-note zone-8">G<sub>#</sub>5 A<sub>♭</sub>6</td>
    <th class="zone-8">A5</th>
    <td class="missing-note zone-8">A<sub>#</sub>5 B<sub>♭</sub>5</td>
    <td class="missing-note zone-9">B5</td>
  </tr>
  <tr>
    <th class="zone-9">C6</th>
    <td class="missing-note zone-9">C<sub>#</sub>6 D<sub>♭</sub>6</td>
    <td class="missing-note zone-10">D6</td>
    <th class="zone-10">D<sub>#</sub>6 E<sub>♭</sub>6</th>
    <td class="missing-note zone-10">E6</td>
    <td class="missing-note zone-11">F6</td>
    <th class="zone-11">F<sub>#</sub>6 G<sub>♭</sub>6</th>
    <td class="missing-note zone-11">G6</td>
    <td class="missing-note zone-12">G<sub>#</sub>6 A<sub>♭</sub>7</td>
    <th class="zone-12">A6</th>
    <td class="missing-note zone-12">A<sub>#</sub>6 B<sub>♭</sub>6</td>
    <td class="missing-note zone-12">B6</td>
  </tr>
</tbody></table>

<style type="text/css">
.zone-1  { background-color: #eef; }
.zone-2  { background-color: #efe; }
.zone-3  { background-color: #fee; }
.zone-4  { background-color: #eff; }
.zone-5  { background-color: #fef; }
.zone-6  { background-color: #ffe; }
.zone-7  { background-color: #dde; }
.zone-8  { background-color: #ded; }
.zone-9  { background-color: #edd; }
.zone-10 { background-color: #cce; }
.zone-11 { background-color: #cec; }
.zone-12 { background-color: #ecc; }
</style>

<p>The main function of our sampler will be one that takes the name of an instrument and a note to play. We'll expect it to return a sample that we'll be able to play (or, rather, a <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> that resolves to a sample):</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSample</span>(<span class="hljs-params">instrument, noteAndOctave</span>) </span>{

}
</pre>

<p>For each instrument we'll store a little "sample library" data structure, which records what note samples we have for that instrument, and where those sample files can be located. Let's put the grand piano samples for octaves 4-6 in it:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-keyword">const</span> SAMPLE_LIBRARY = {
  <span class="hljs-string">'Grand Piano'</span>: [
    { note: <span class="hljs-string">'A'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-a4.wav'</span> },
    { note: <span class="hljs-string">'A'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-a5.wav'</span> },
    { note: <span class="hljs-string">'A'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-a6.wav'</span> },
    { note: <span class="hljs-string">'C'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-c4.wav'</span> },
    { note: <span class="hljs-string">'C'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-c5.wav'</span> },
    { note: <span class="hljs-string">'C'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-c6.wav'</span> },
    { note: <span class="hljs-string">'D#'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-d#4.wav'</span> },
    { note: <span class="hljs-string">'D#'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-d#5.wav'</span> },
    { note: <span class="hljs-string">'D#'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-d#6.wav'</span> },
    { note: <span class="hljs-string">'F#'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-f#4.wav'</span> },
    { note: <span class="hljs-string">'F#'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-f#5.wav'</span> },
    { note: <span class="hljs-string">'F#'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-f#6.wav'</span> }
  ]
};
</pre>

<p>So now we're going to need to find, for any note given to <code>getSample</code>, the nearest note we have in the sample library. Before we can do that, we need to normalize the input notes a little bit.</p>

<p>Firstly, we should split the incoming note string (<code>"B#4"</code>) into the note characters (<code>"B#"</code>) and the octave digit (<code>"4"</code>). We can do so with a regular expression that pulls the two parts into separate <a href="http://www.regular-expressions.info/refcapture.html">capture groups</a>.</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSample</span>(<span class="hljs-params">instrument, noteAndOctave</span>) </span>{
  <span class="codeblock-highlight"><span class="hljs-keyword">let</span> [, requestedNote, requestedOctave] = <span class="hljs-regexp">/^(\w[b#]?)(\d)$/</span>.exec(noteAndOctave);</span>
  <span class="codeblock-highlight">requestedOctave = <span class="hljs-built_in">parseInt</span>(requestedOctave, <span class="hljs-number">10</span>);</span>
}
</pre>

<p>The group <code>(\w[b#]?)</code> captures a single word character optionally followed by a <code>'b'</code> or a <code>'#'</code>, and <code>(\d)</code> captures a single digit. We then also <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/parseInt">parse</a> the octave from a string to a integer number.</p>

<p>The Sonatina library contains samples for natural notes and <a href="https://en.wikipedia.org/wiki/Sharp_(music)">sharp (#) notes</a> only, but we would like to also support <a href="https://en.wikipedia.org/wiki/Flat_(music)">flat (♭) notes</a>. We'll exploit the fact that for every flat note there is an <a href="https://en.wikipedia.org/wiki/Enharmonic">"enharmonically equivalent"</a> sharp note. This basically just means the same note may be written in two different ways, sharp or flat.</p>

<p>We can make a little function that eliminates flats completely by turning them into their equivalent sharps. For example, for the flat <code>Bb</code> we get the equivalent sharp <code>A#</code>:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flatToSharp</span>(<span class="hljs-params">note</span>) </span>{
  <span class="hljs-keyword">switch</span> (note) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Bb'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'A#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Db'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'C#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Eb'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'D#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Gb'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'F#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Ab'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'G#'</span>;
    <span class="hljs-keyword">default</span>:   <span class="hljs-keyword">return</span> note;
  }
}</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSample</span>(<span class="hljs-params">instrument, noteAndOctave</span>) </span>{
  <span class="hljs-keyword">let</span> [, requestedNote, requestedOctave] = <span class="hljs-regexp">/^(\w[b#]?)(\d)$/</span>.exec(noteAndOctave);
  requestedOctave = <span class="hljs-built_in">parseInt</span>(requestedOctave, <span class="hljs-number">10</span>);
  <span class="codeblock-highlight">requestedNote = flatToSharp(requestedNote);</span>
}
</pre>

<p>In order to find the "nearest" note for a given input note, we need a way to measure the distance between two notes. This calls for a purely numeric note representation.</p>

<p>First of all, there are twelve notes ("semitones") in each octave, and each octave begins from the <code>C</code> note:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-keyword">const</span> OCTAVE = [<span class="hljs-string">'C'</span>, <span class="hljs-string">'C#'</span>, <span class="hljs-string">'D'</span>, <span class="hljs-string">'D#'</span>, <span class="hljs-string">'E'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F#'</span>, <span class="hljs-string">'G'</span>, <span class="hljs-string">'G#'</span>, <span class="hljs-string">'A'</span>, <span class="hljs-string">'A#'</span>, <span class="hljs-string">'B'</span>];
</pre>

<p>Using this information, given a note and an octave, we can come up with an integer number that uniquely identifies that note:</p>

<ol>
<li>Identify the octave's base note by multiplying the octave number by 12: For the note D3, the octave is 3 so we get <code>3 * 12 = 36</code>.</li>
<li>Find the index of the note within the octave. D3 is the third note in the octave, D, so its index is <code>2</code>.</li>
<li>Sum those together to get the note's numeric value. For D3, <code>36 + 2 = 38</code>.</li>
</ol>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-keyword">const</span> OCTAVE = [<span class="hljs-string">'C'</span>, <span class="hljs-string">'C#'</span>, <span class="hljs-string">'D'</span>, <span class="hljs-string">'D#'</span>, <span class="hljs-string">'E'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F#'</span>, <span class="hljs-string">'G'</span>, <span class="hljs-string">'G#'</span>, <span class="hljs-string">'A'</span>, <span class="hljs-string">'A#'</span>, <span class="hljs-string">'B'</span>];

<span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noteValue</span>(<span class="hljs-params">note, octave</span>) </span>{
  <span class="hljs-keyword">return</span> octave * <span class="hljs-number">12</span> + OCTAVE.indexOf(note);
}</span>
</pre>

<p>Based on this, we can form a function that calculates the distance between any two notes. It takes two note names and octaves and simply subtracts one's value from the other:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNoteDistance</span>(<span class="hljs-params">note1, octave1, note2, octave2</span>) </span>{
  <span class="hljs-keyword">return</span> noteValue(note1, octave1) - noteValue(note2, octave2);
}
</pre>

<p>Now we have the building blocks of a function that finds the nearest sample given an instrument's sample bank, note, and octave. It <a href="https://davidwalsh.name/array-sort">sorts</a> the sample bank array by the absolute distance to the requested note. It then returns the sample with the shortest distance, which will be the first sample in the sorted array.</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNearestSample</span>(<span class="hljs-params">sampleBank, note, octave</span>) </span>{
  <span class="hljs-keyword">let</span> sortedBank = sampleBank.slice().sort((sampleA, sampleB) =&gt; {
    <span class="hljs-keyword">let</span> distanceToA =
      <span class="hljs-built_in">Math</span>.abs(getNoteDistance(note, octave, sampleA.note, sampleA.octave));
    <span class="hljs-keyword">let</span> distanceToB =
      <span class="hljs-built_in">Math</span>.abs(getNoteDistance(note, octave, sampleB.note, sampleB.octave));
    <span class="hljs-keyword">return</span> distanceToA - distanceToB;
  });
  <span class="hljs-keyword">return</span> sortedBank[<span class="hljs-number">0</span>];
}
</pre>

<p>The final helper function we'll need for our sampler is one that actually loads a sample file from the server. The code for that is very similar to the one we had for "It's Gonna Rain". It fetches and decodes the sample file. For this we also need to instantiate an <code>AudioContext</code>:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> audioContext = <span class="hljs-keyword">new</span> AudioContext();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchSample</span>(<span class="hljs-params">path</span>) </span>{
  <span class="hljs-keyword">return</span> fetch(<span class="hljs-built_in">encodeURIComponent</span>(path))
    .then(response =&gt; response.arrayBuffer())
    .then(arrayBuffer =&gt; audioContext.decodeAudioData(arrayBuffer));
}
</pre>

<p>Note that we use the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">encodeURIComponent</a> function to sanitize the file path before giving it to <code>fetch</code>. It's needed because our filenames may have <code>'#'</code> characters, which need to be escaped when used inside URLs.</p>

<p>Now we can put all of this together, so that <code>getSample</code> always returns an <code>AudioBuffer</code> as well as a number that denotes the distance between the sample that was requested and the one that was found.</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSample</span>(<span class="hljs-params">instrument, noteAndOctave</span>) </span>{
  <span class="hljs-keyword">let</span> [, requestedNote, requestedOctave] = <span class="hljs-regexp">/^(\w[b\#]?)(\d)$/</span>.exec(noteAndOctave);
  requestedOctave = <span class="hljs-built_in">parseInt</span>(requestedOctave, <span class="hljs-number">10</span>);
  requestedNote = flatToSharp(requestedNote);
<span class="codeblock-highlight">  <span class="hljs-keyword">let</span> sampleBank = SAMPLE_LIBRARY[instrument];
  <span class="hljs-keyword">let</span> sample = getNearestSample(sampleBank, requestedNote, requestedOctave);
  <span class="hljs-keyword">let</span> distance =
    getNoteDistance(requestedNote, requestedOctave, sample.note, sample.octave);
  <span class="hljs-keyword">return</span> fetchSample(sample.file).then(audioBuffer =&gt; ({
    audioBuffer: audioBuffer,
    distance: distance
  }));</span>
}
</pre>

<p>In the case of the grand piano sample bank, the distances between requested and found samples range from -1 to 1 because we always have a sample at most one semitone away. But other instruments may have longer distances. This distance determines the amount of pitch-shifting we'll have to do.</p>

<p>Pitch-shifting is done by adjusting the <em>frequency</em> of the sound wave formed by a sample, and there's a simple formula for determining the size of the adjustment.</p>

<p>The key idea is that the relationship between musical notes and the underlying sound frequencies is exponential. Going up an octave always doubles the frequency of the sound wave, so if we want to pitch-shift a whole octave we need to double the frequency:</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/octave-up-calculation.png">
  <figcaption>Going an octave up from C to C' means doubling the frequency.</figcaption>
</figure>

<p>Since an octave is divided into 12 semitones, going up a single semitone means multiplying the frequency by a fractional power of two: 2<sup>1/12</sup>. And going up <code>n</code> semitones means multiplying the frequency by 2<sup>n/12</sup>. The same applies when going down, but then we multiply by negative exponents: 2<sup>-n/12</sup>:</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/up-down-note-calculations.png">
  <figcaption>Going up or down n semitones means multiplying the frequency by a fractional power of 2.</figcaption>
</figure>

<p>When we are playing sample files, we can't really just "set the frequency" of a sample directly. But what we can do is set the <em>playback rate</em> of the sample, because this will compress or expand its sound wave in time by the same ratio. To achieve a lower note, we simply play the sample more slowly, and to reach a higher note we play it more quickly.</p>

<p>Armed with this information we can come up with an expression that, given the distance to a note, gives us the playback rate we need to use. A zero distance gives the original playback rate, 1, since 2<sup>0/12</sup> = 2<sup>0</sup> = 1, whereas distance of one semitone should return a playback rate of 2<sup>1/12</sup> ≈ 1.059. This will make the sound play slightly faster, causing our ears to perceive it as a higher note.</p>

<pre class="hljs "><span class="hljs-keyword">let</span> playbackRate = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, distance / <span class="hljs-number">12</span>);
</pre>

<p>Now we can form a function that actually plays any musical note for any instrument. It uses <code>getSample</code> to fetch the nearest sample, waits for the result, and then plays back the sample with the appropriate playback rate.</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">playSample</span>(<span class="hljs-params">instrument, note</span>) </span>{
  getSample(instrument, note).then(({audioBuffer, distance}) =&gt; {
    <span class="hljs-keyword">let</span> playbackRate = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, distance / <span class="hljs-number">12</span>);
    <span class="hljs-keyword">let</span> bufferSource = audioContext.createBufferSource();
    bufferSource.buffer = audioBuffer;
    bufferSource.playbackRate.value = playbackRate;
    bufferSource.connect(audioContext.destination);
    bufferSource.start();
  });
}
</pre>

<div class="aside">
  <p>
    A general purpose sampler should also <em>cache</em> the sample buffers somewhere in memory instead of
    fetching them again each time they're needed. But this is good enough for us right now.
  </p>
</div>

<p>Here's the complete code we have written so far, combined with some test code that plays the seven notes from "Airports" at one second intervals:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs has-player player-coranglais-once"><span class="hljs-keyword">const</span> SAMPLE_LIBRARY = {
  <span class="hljs-string">'Grand Piano'</span>: [
    { note: <span class="hljs-string">'A'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-a4.wav'</span> },
    { note: <span class="hljs-string">'A'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-a5.wav'</span> },
    { note: <span class="hljs-string">'A'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-a6.wav'</span> },
    { note: <span class="hljs-string">'C'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-c4.wav'</span> },
    { note: <span class="hljs-string">'C'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-c5.wav'</span> },
    { note: <span class="hljs-string">'C'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-c6.wav'</span> },
    { note: <span class="hljs-string">'D#'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-d#4.wav'</span> },
    { note: <span class="hljs-string">'D#'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-d#5.wav'</span> },
    { note: <span class="hljs-string">'D#'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-d#6.wav'</span> },
    { note: <span class="hljs-string">'F#'</span>,  octave: <span class="hljs-number">4</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-f#4.wav'</span> },
    { note: <span class="hljs-string">'F#'</span>,  octave: <span class="hljs-number">5</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-f#5.wav'</span> },
    { note: <span class="hljs-string">'F#'</span>,  octave: <span class="hljs-number">6</span>, file: <span class="hljs-string">'Samples/Grand Piano/piano-f-f#6.wav'</span> }
  ]
};
<span class="hljs-keyword">const</span> OCTAVE = [<span class="hljs-string">'C'</span>, <span class="hljs-string">'C#'</span>, <span class="hljs-string">'D'</span>, <span class="hljs-string">'D#'</span>, <span class="hljs-string">'E'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F#'</span>, <span class="hljs-string">'G'</span>, <span class="hljs-string">'G#'</span>, <span class="hljs-string">'A'</span>, <span class="hljs-string">'A#'</span>, <span class="hljs-string">'B'</span>];

<span class="hljs-keyword">let</span> audioContext = <span class="hljs-keyword">new</span> AudioContext();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchSample</span>(<span class="hljs-params">path</span>) </span>{
  <span class="hljs-keyword">return</span> fetch(<span class="hljs-built_in">encodeURIComponent</span>(path))
    .then(response =&gt; response.arrayBuffer())
    .then(arrayBuffer =&gt; audioContext.decodeAudioData(arrayBuffer));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noteValue</span>(<span class="hljs-params">note, octave</span>) </span>{
  <span class="hljs-keyword">return</span> octave * <span class="hljs-number">12</span> + OCTAVE.indexOf(note);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNoteDistance</span>(<span class="hljs-params">note1, octave1, note2, octave2</span>) </span>{
  <span class="hljs-keyword">return</span> noteValue(note1, octave1) - noteValue(note2, octave2);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getNearestSample</span>(<span class="hljs-params">sampleBank, note, octave</span>) </span>{
  <span class="hljs-keyword">let</span> sortedBank = sampleBank.slice().sort((sampleA, sampleB) =&gt; {
    <span class="hljs-keyword">let</span> distanceToA =
      <span class="hljs-built_in">Math</span>.abs(getNoteDistance(note, octave, sampleA.note, sampleA.octave));
    <span class="hljs-keyword">let</span> distanceToB =
      <span class="hljs-built_in">Math</span>.abs(getNoteDistance(note, octave, sampleB.note, sampleB.octave));
    <span class="hljs-keyword">return</span> distanceToA - distanceToB;
  });
  <span class="hljs-keyword">return</span> sortedBank[<span class="hljs-number">0</span>];
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flatToSharp</span>(<span class="hljs-params">note</span>) </span>{
  <span class="hljs-keyword">switch</span> (note) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Bb'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'A#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Db'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'C#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Eb'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'D#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Gb'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'F#'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'Ab'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'G#'</span>;
    <span class="hljs-keyword">default</span>:   <span class="hljs-keyword">return</span> note;
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSample</span>(<span class="hljs-params">instrument, noteAndOctave</span>) </span>{
  <span class="hljs-keyword">let</span> [, requestedNote, requestedOctave] = <span class="hljs-regexp">/^(\w[b\#]?)(\d)$/</span>.exec(noteAndOctave);
  requestedOctave = <span class="hljs-built_in">parseInt</span>(requestedOctave, <span class="hljs-number">10</span>);
  requestedNote = flatToSharp(requestedNote);
  <span class="hljs-keyword">let</span> sampleBank = SAMPLE_LIBRARY[instrument];
  <span class="hljs-keyword">let</span> sample = getNearestSample(sampleBank, requestedNote, requestedOctave);
  <span class="hljs-keyword">let</span> distance =
    getNoteDistance(requestedNote, requestedOctave, sample.note, sample.octave);
  <span class="hljs-keyword">return</span> fetchSample(sample.file).then(audioBuffer =&gt; ({
    audioBuffer: audioBuffer,
    distance: distance
  }));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">playSample</span>(<span class="hljs-params">instrument, note</span>) </span>{
  getSample(instrument, note).then(({audioBuffer, distance}) =&gt; {
    <span class="hljs-keyword">let</span> playbackRate = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, distance / <span class="hljs-number">12</span>);
    <span class="hljs-keyword">let</span> bufferSource = audioContext.createBufferSource();
    bufferSource.buffer = audioBuffer;
    bufferSource.playbackRate.value = playbackRate;
    bufferSource.connect(audioContext.destination);
    bufferSource.start();
  });
}

<span class="hljs-comment">// Temporary test code</span>
setTimeout(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'F4'</span>),  <span class="hljs-number">1000</span>);
setTimeout(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Ab4'</span>), <span class="hljs-number">2000</span>);
setTimeout(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'C5'</span>),  <span class="hljs-number">3000</span>);
setTimeout(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Db5'</span>), <span class="hljs-number">4000</span>);
setTimeout(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Eb5'</span>), <span class="hljs-number">5000</span>);
setTimeout(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'F5'</span>),  <span class="hljs-number">6000</span>);
setTimeout(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Ab5'</span>), <span class="hljs-number">7000</span>);
</pre>

<h3 id="a-system-of-loops">A System of Loops</h3>

<p>Now that we have an instrument to play, we can shift our focus to the <em>system</em> that will play it.</p>

<p>Eno's piece was generated by seven tape loops. Each one contained a recording of a single vocal "aaaahh" sound on one of the seven pitches. The loops all had different <em>durations</em>, between about 20-30 seconds. When you play such a combination of loops together, you get a similar kind of relative shifting of sounds as we have in "It's Gonna Rain". As the loops turn over at different times, the sounds and silences on the tapes constantly reorganize and "generate" new combinations.</p>

<div class="airports-visualization">
  <div class="airports-track airports-track-1">
    <div class="airports-block airports-block-a" style="left: 1080.38px;"></div>
    <div class="airports-block airports-block-b" style="left: 2360.38px;"></div>
  </div>
  <div class="airports-track airports-track-2">
    <div class="airports-block airports-block-a" style="left: 730.929px;"></div>
    <div class="airports-block airports-block-b" style="left: 2010.93px;"></div>
  </div>
  <div class="airports-track airports-track-3">
    <div class="airports-block airports-block-a" style="left: 968.616px;"></div>
    <div class="airports-block airports-block-b" style="left: 2248.62px;"></div>
  </div>
  <div class="airports-track airports-track-4">
    <div class="airports-block airports-block-a" style="left: 1093.38px;"></div>
    <div class="airports-block airports-block-b" style="left: 2373.38px;"></div>
  </div>
  <div class="airports-track airports-track-5">
    <div class="airports-block airports-block-a" style="left: 195.723px;"></div>
    <div class="airports-block airports-block-b" style="left: 1475.72px;"></div>
  </div>
  <div class="airports-track airports-track-6">
    <div class="airports-block airports-block-a" style="left: 498.296px;"></div>
    <div class="airports-block airports-block-b" style="left: 1778.3px;"></div>
  </div>
  <div class="airports-track airports-track-7">
    <div class="airports-block airports-block-a" style="left: 914.677px;"></div>
    <div class="airports-block airports-block-b" style="left: 2194.68px;"></div>
  </div>
</div>

<style type="text/css">
  @keyframes shifttrack {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  .airports-visualization {
    overflow: hidden;
    margin-bottom: 1em;
  }
  .airports-track {
    position: relative;
    width: 200%;
    margin: 5px 0;
    background-color: #eee;
    height: 15px;
  }
  .airports-track-1 {
    animation: shifttrack 30s linear 0s infinite;
  }
  .airports-track-2 {
    animation: shifttrack 32s linear 0s infinite;
  }
  .airports-track-3 {
    animation: shifttrack 27s linear 0s infinite;
  }
  .airports-track-4 {
    animation: shifttrack 25s linear 0s infinite;
  }
  .airports-track-5 {
    animation: shifttrack 36s linear 0s infinite;
  }
  .airports-track-6 {
    animation: shifttrack 31s linear 0s infinite;
  }
  .airports-track-7 {
    animation: shifttrack 25s linear 0s infinite;
  }
  .airports-block {
    position: absolute;
    width: 10%;
    height: 15px;
    background-color: rgb(237,20,111);
  }
</style>

<script>
function initAirportsVis() {
  var width = document.documentElement.offsetWidth;
  [1, 2, 3, 4, 5, 6, 7].forEach(function(n) {
    var track = document.querySelector('.airports-track-' + n);
    var blockA = track.querySelector('.airports-block-a');
    var blockB = track.querySelector('.airports-block-b');
    var left = Math.random() * width * 0.9;
    blockA.style.left = left + 'px';
    blockB.style.left = (width + left) + 'px';
  });
}
initAirportsVis();
window.addEventListener('resize', initAirportsVis);
</script>

<p>Once again, it's really a very simple system compared to what the results sound like! This conceptual simplicity does not mean the piece was easy to execute though. The 20-30 second durations of these tape loops were way more than the 1-2 seconds that the tape recorders of the time were equipped to handle. Eno had to resort to some epic hacks to make it all work.</p>

<blockquote cite="./JavaScript Systems Music_files/eno1.html">
  One of the notes repeats every 23 1/2 seconds. It is in fact a long loop running around a series of tubular aluminum chairs in Conny Plank's studio. The next lowest loop repeats every 25 7/8 seconds or something like that. The third one every 29 15/16 seconds or something.
  What I mean is they all repeat in cycles that are called incommensurable — they are not likely to come back into sync again.
  <footer>Brian Eno, <a href="./JavaScript Systems Music_files/eno1.html">1996</a></footer>
</blockquote>

<p>And how much of unique music can we generate with this technique? This depends on the relative durations of the loops (or, "lengths of tape") that we choose. If we have two loops, both with a duration of 2 seconds, the duration of our whole piece is 2 seconds since the whole thing just keeps repeating.</p>

<div style="height: 100px; margin: 2em 0; background-image: url(&#39;/images/incommensurable-2.png&#39;); background-repeat: repeat-x; background-size: auto 100%;"></div>

<p>But if we make the duration of the second loop 3 seconds instead of 2, the duration of our whole piece doubles to 6 seconds. This is because the next time the two loops start at the same time is after six seconds. That's when the system will have exhausted all of its musical combinations.</p>

<div style="height: 100px; margin: 2em 0; background-image: url(&#39;/images/incommensurable-2-3.png&#39;); background-repeat: repeat-x; background-size: auto 100%;"></div>

<p>By adjusting the two numbers we can make the piece much longer. If we make one loop only slightly longer than the other, it'll take a while for them to meet again. This is how Reich was able to squeeze out 6 minutes worth of music from two sub-second loops. He varied the <em>playback rate</em> rather than the tape length, but the result was effectively the same.</p>

<div style="height: 100px; margin: 2em 0; background-image: url(&#39;/images/incommensurable-2-22.png&#39;); background-repeat: repeat-x; background-size: auto 100%;"></div>

<p>But it is when we bring in a third loop that the system really takes off. We won't have heard all the combinations the system is able to produce until we reach a moment when <em>all of the three loops meet at the same time</em>. That's going to take some time.</p>

<div style="height: 150px; margin: 2em 0; background-image: url(&#39;/images/incommensurable-2-22-14.png&#39;); background-repeat: repeat-x; background-size: auto 100%;"></div>

<p>You can see how bringing in <em>four more</em> loops with similarly differing durations results in a piece of music that's very long indeed. That's pretty striking, giving the extremely limited amount of sonic material and the simplicity of the system.</p>

<p>Now of course, you don't have to listen for very long until you've figured out what <em>type</em> of music is being made. You can listen to it for a thousand years and it'll never play "Hotline Bling". It simply varies the relative timings of its seven notes. But in any case, anyone who buys a copy of the "Music for Airports" album only gets to hear a tiny 9 minute clip of the vast amount of music this system is capable of making.</p>

<h3 id="playing-extended-loops">Playing Extended Loops</h3>

<p>Let's construct these loops in our project. Recall that with "It's Gonna Rain" we looped sounds by simply setting the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/loop"><code>loop</code> property</a> of the buffer source nodes to <code>true</code>, which made the sounds repeat. This time the loops are longer - much longer than the individual sample files in fact, so we can't apply the same trick here.</p>

<p>Eno had to set up physical contraptions to make his tape loops go around the studio space. Our equivalent of this is to use JavaScript's built-in <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setInterval">setInterval</a> function, which executes a given callback function with a regular time interval. If we make a callback that plays one of the sounds every 20 seconds, we have an "extended" loop. Replace the test <code>setTimeout</code> test code in <code>musicforairports.js</code> with this:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs has-player player-coranglais-single">setInterval(() =&gt; playSample(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'C4'</span>), <span class="hljs-number">20000</span>);
</pre>

<p>With this version we do need to wait for about 20 seconds before the <em>first</em> note plays too, which we may not want to do. Instead we can write a function that plays the sound once immediately and <em>after that</em> sets up the interval:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs has-player player-coranglais-single-immediate"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startLoop</span>(<span class="hljs-params">instrument, note, loopLengthSeconds</span>) </span>{
  playSample(instrument, note);
  setInterval(() =&gt; playSample(instrument, note), loopLengthSeconds * <span class="hljs-number">1000</span>);
}

startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'C4'</span>, <span class="hljs-number">20</span>);
</pre>

<p>Since we're going to set up several loops, we should also have the possibility to add <em>initial delays</em> to them, so that all the sounds won't play at exactly the same time in the beginning. So, we should have another number that delays the playing of the sound <em>within</em> the loop. It controls at which section of our virtual "tape" the sound is recorded.</p>

<p>We can achieve this by adding a <code>delay</code> argument to the <code>playSample</code> function. It passes a new argument to the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/start">bufferSource.start()</a> method - the time at which the sound should begin playing, relative to the AudioContext's <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/currentTime">current time</a>:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">playSample</span>(<span class="hljs-params">instrument, note</span></span><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-params">, delaySeconds = 0</span></span></span><span class="hljs-function">) </span>{
  getSample(instrument, note).then(({audioBuffer, distance}) =&gt; {
    <span class="hljs-keyword">let</span> playbackRate = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, distance / <span class="hljs-number">12</span>);
    <span class="hljs-keyword">let</span> bufferSource = audioContext.createBufferSource();
    bufferSource.buffer = audioBuffer;
    bufferSource.playbackRate.value = playbackRate;
    bufferSource.connect(audioContext.destination);
    bufferSource.start(<span class="codeblock-highlight">audioContext.currentTime + delaySeconds</span>);
  });
}
</pre>

<p>We already saw this argument with "It's Gonna Rain", but we were just using <code>0</code> as the value then to get immediate playback.</p>

<p>To test this version, we can set up a five second delay to our loop:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs has-player player-coranglais-single-delayed"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startLoop</span>(<span class="hljs-params">instrument, note, loopLengthSeconds</span></span><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-params">, delaySeconds</span></span></span><span class="hljs-function">) </span>{
  playSample(instrument, note<span class="codeblock-highlight">, delaySeconds</span>);
  setInterval(
    () =&gt; playSample(instrument, note<span class="codeblock-highlight">, delaySeconds</span>),
    loopLengthSeconds * <span class="hljs-number">1000</span>
  );
}

startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'C4'</span>, <span class="hljs-number">20</span><span class="codeblock-highlight">, <span class="hljs-number">5</span></span>);
</pre>

<p>Our Web Audio node graph at this point is very simple. There's at most just one <code>AudioBufferSourceNode</code> playing a sound, since we've got a single loop running:</p>

<figure class="diagram" style="max-width: 450px">
  <img src="./JavaScript Systems Music_files/webaudio-graph-airports-single.png">
  <figcaption>Web Audio graph with one source added by the extended loop.</figcaption>
</figure>

<p>What's different this time though is that the node graph is not static. Every 20 seconds we attach a new source node. After it's finished playing it'll get automatically removed, at which point the graph contains nothing but the destination node.</p>

<figure class="diagram" style="max-width: 450px">
  <img src="./JavaScript Systems Music_files/webaudio-graph-airports-single-gone.png">
  <figcaption>The source is removed and destroyed once it finishes playing.</figcaption>
</figure>

<p>Having <em>dynamic graphs</em> such as this is very common with Web Audio. In fact, you can't even start an <code>AudioBufferSourceNode</code> more than once. Every time you want to play a sound, you make a new node, even when it's for a sound you've played before.</p>

<div class="aside">
<p>
  While the simple <code>setInterval()</code> based solution will work just fine for us, I should mention that it is not precise enough for most Web Audio applications. This is because JavaScript does not give exact guarantees about the timing of <code>setInterval()</code>. If something else is making the computer busy at the moment when the timer should fire, it may get delayed. It's not at all uncommon for this to happen.
</p>
<p>
  Four our purposes though, I actually like that it's a bit inexact. We're dealing with the kind of application where scheduling is very porous anyway. Furthermore, this was a characteristic of the equipment Eno was using as well. The motors in his tape recorders were not exact to a millisecond precision, especially when he stretched them way beyond what they were originally designed for.
</p>
<p>
  For the kinds of applications you <em>do</em> need precision for, you'll need to calculate the exact offsets manually and give them to <code>bufferSource.start()</code>.  There are good <a href="http://www.html5rocks.com/en/tutorials/audio/scheduling/">articles</a> and <a href="https://github.com/sebpiq/WAAClock">libraries</a> that help with this. We will also see how to achieve
  exact timing with the Tone.js library in the next chapter.
</p>
</div>

<h3 id="adding-reverb">Adding Reverb</h3>

<p>If you compare our grand piano loop to how Eno's original piece sounds, you'll hear a big difference.</p>

<p>Of course, this is mostly due to the fact that we're using completely different instruments, resulting in an entirely different <a href="https://en.wikipedia.org/wiki/Timbre">timbre</a>. But that's not the only difference. You'll notice that Eno's sounds seem to emerge from the ether very softly and then also fade back down gently, whereas our samples have a much rougher entrance and exit.</p>

<p>There are a number of ways we could adjust this. One very effective way to change the perception of the sound is to add some <a href="https://en.wikipedia.org/wiki/Reverberation">reverberation</a> to it, making it seem like the sound is reflecting in a physical space. This will especially affect the part where the sound stops playing: Instead of all sound disappearing instantly, the reflections in the virtual space will linger.</p>

<p>The Web Audio API comes with an interface called <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/createConvolver">ConvolverNode</a> that can achieve this kind of an effect. It applies something called a <a href="https://en.wikipedia.org/wiki/Convolution">convolution</a> to a sound signal, by combining it with another sound signal called an <a href="https://en.wikipedia.org/wiki/Finite_impulse_response">acoustic impulse response</a>. The exact math behind this is beyond the scope of this guide and to be honest I don't fully understand it. But it sounds pretty damn cool, which is the most important thing.</p>

<p>To use <code>ConvolverNode</code> we need to obtain an <em>impulse response sample</em> that will be used to convolve our audio source. As it happens, someone by the name of AirWindows <a href="http://www.airwindows.com/airwindows-impulses/">has made a free one called "airport terminal"</a>, which is fantastically appropriate for our purposes and our theme. It's not actually recorded in a real airport terminal, but it simulates the massive amount of reverb you get in one.</p>

<p>I've made a suitable stereo <code>.wav</code> file of this impulse response, which you can get <a href="http://teropa.info/sounds/AirportTerminal.wav">here</a>. Place it within the <code>musicforairports</code> directory. Then modify the code that starts our audio loop so that it first fetches this file as an audio buffer and then creates a convolver node based on it. The node is given to <code>startLoop</code> as a new argument:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="codeblock-highlight">fetchSample(<span class="hljs-string">'AirportTerminal.wav'</span>).then(convolverBuffer =&gt; {</span>

  <span class="codeblock-highlight"><span class="hljs-keyword">let</span> convolver = audioContext.createConvolver();</span>
  <span class="codeblock-highlight">convolver.buffer = convolverBuffer;</span>
  <span class="codeblock-highlight">convolver.connect(audioContext.destination);</span>

  startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'C4'</span>, <span class="codeblock-highlight">convolver,</span> <span class="hljs-number">20</span>, <span class="hljs-number">5</span>);
<span class="codeblock-highlight">});</span>
</pre>

<p>Then modify <code>startLoop</code> so that it passes the new argument (called <code>destination</code>) onward to <code>playSample</code>:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startLoop</span>(<span class="hljs-params">instrument, note, </span></span><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-params">destination,</span></span></span><span class="hljs-function"><span class="hljs-params"> loopLengthSeconds, delaySeconds</span>) </span>{
  playSample(instrument, note, <span class="codeblock-highlight">destination,</span> delaySeconds);
  setInterval(
    () =&gt; playSample(instrument, note, <span class="codeblock-highlight">destination,</span> delaySeconds),
    loopLengthSeconds * <span class="hljs-number">1000</span>
  );
}
</pre>

<p>And finally, modify <code>playSample</code> so that it sends its audio signal to the given destination instead of the audio context's final destination node. This causes all of the samples to flow through the convolver node:</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs has-player player-coranglais-single-convolved"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">playSample</span>(<span class="hljs-params">instrument, note, </span></span><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-params">destination,</span></span></span><span class="hljs-function"><span class="hljs-params"> delaySeconds = 0</span>) </span>{
  getSample(instrument, note).then(({audioBuffer, distance}) =&gt; {
    <span class="hljs-keyword">let</span> playbackRate = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, distance / <span class="hljs-number">12</span>);
    <span class="hljs-keyword">let</span> bufferSource = audioContext.createBufferSource();

    bufferSource.buffer = audioBuffer;
    bufferSource.playbackRate.value = playbackRate;

    <span class="codeblock-highlight">bufferSource.connect(destination);</span>
    bufferSource.start(audioContext.currentTime + delaySeconds);
  });
}
</pre>

<p>This makes a big difference in the sound produced! As far as reverberation effects go, it's certainly among the most dramatic and it completely changes the nature of the music. If it proves too massive to your liking, try one of the others from <a href="http://www.airwindows.com/airwindows-impulses/">AirWindows</a> or use one from&nbsp;<a href="http://www.openairlib.net/auralizationdb">this database compiled by The University of York</a>.</p>

<p>Here's what the Web Audio node graphs produced by this code look like:</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-airports-single-convolved.png">
  <figcaption>Web Audio graph with a single source and a convolver.</figcaption>
</figure>

<h3 id="putting-it-together-launching-the-loops">Putting It Together: Launching the Loops</h3>

<p>With our sampler and reverbed loops, we can now prop up the whole system that produces our approximation of "Music for Airports 2/1". This is simply done by calling <code>startLoop</code> several times, once for each of the musical notes that we want to play.</p>

<p>Here we need to come up with a bunch of numeric values: We need to decide the <em>duration</em> of each loop, and the <em>delay</em> by which each sound is positioned inside its loop. Of these two, the loop durations are much more important since, as we saw earlier, making them <em>incommensurable</em> will cause the system to produce a very long piece of unique music. The <em>delays</em> on the other hand have less of an impact. They basically control how the music <em>begins</em> but very soon their role will diminish as the differences in the loop durations take over.</p>

<p>Here's an example set of numbers. Their exact values are not hugely important. The story tells that Eno merely cut the tapes up to what he thought were "reasonable lengths" without giving it much thought. We may just as well do the same.</p>

<div class="codeblock-banner">musicforairports.js</div>

<pre class="hljs ">fetchSample(<span class="hljs-string">'AirportTerminal.wav'</span>).then(convolverBuffer =&gt; {

  <span class="hljs-keyword">let</span> convolver = audioContext.createConvolver();
  convolver.buffer = convolverBuffer;
  convolver.connect(audioContext.destination);

  <span class="codeblock-highlight">startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'F4'</span>,  convolver, <span class="hljs-number">19.7</span>, <span class="hljs-number">4.0</span>);</span>
  <span class="codeblock-highlight">startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Ab4'</span>, convolver, <span class="hljs-number">17.8</span>, <span class="hljs-number">8.1</span>);</span>
  <span class="codeblock-highlight">startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'C5'</span>,  convolver, <span class="hljs-number">21.3</span>, <span class="hljs-number">5.6</span>);</span>
  <span class="codeblock-highlight">startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Db5'</span>, convolver, <span class="hljs-number">22.1</span>, <span class="hljs-number">12.6</span>);</span>
  <span class="codeblock-highlight">startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Eb5'</span>, convolver, <span class="hljs-number">18.4</span>, <span class="hljs-number">9.2</span>);</span>
  <span class="codeblock-highlight">startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'F5'</span>,  convolver, <span class="hljs-number">20.0</span>, <span class="hljs-number">14.1</span>);</span>
  <span class="codeblock-highlight">startLoop(<span class="hljs-string">'Grand Piano'</span>, <span class="hljs-string">'Ab5'</span>, convolver, <span class="hljs-number">17.7</span>, <span class="hljs-number">3.1</span>);</span>
});
</pre>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-airports-system.png">
  <figcaption>A snapshot of the Web Audio graph formed by the Music for Airports system.</figcaption>
</figure>

<p>And here is this particular system in action:</p>

<div class="player-area">
  <h4>"Music for Airports"</h4>
  <div class="player musicforairports">
    <canvas class="spinners" width="650" height="650" style="cursor: pointer; width: 100%"></canvas>
  </div>
</div>

<p>It's a fascinating feeling to set one of these systems off. You created it but you don't know what it's going to do. To me this captures some of the magic I felt when I was just getting started with programming, which I don't feel that often these days as a working software engineer. Even though there's absolutely nothing random about the system – its behavior is fully deterministic – you really have no idea what it's going to sound like. Those twelve numbers specify the system's behavior completely but the system <em>seems</em> much more complicated than that. The complexity is emergent.</p>

<p>Eno has compared making musical systems like these to "gardening", as opposed to "architecting". We plant the seeds for the system, but then let it grow by itself and surprise us by the music that it makes.</p>

<blockquote cite="./JavaScript Systems Music_files/brian_eno-composers-as-gardeners">
  What this means, really, is a rethinking of one's own position as a creator.  You stop thinking of yourself as me, the controller, you the audience, and you start thinking of all of us as the audience, all of us as people enjoying the garden together.  Gardener included.
  <footer>Brian Eno, <a href="./JavaScript Systems Music_files/brian_eno-composers-as-gardeners">Composers as Gardeners</a></footer>
</blockquote>

<h3 id="exploring-variations-on-music-for-airports">Exploring Variations on Music for Airports</h3>

<p>This is a much more complex systems than "It's Gonna Rain", and as such provides a lot more room for all kinds of experimentation. See if any of the following tickles your interest:</p>

<ul>
<li>Make the durations considerably shorter or longer. You may notice that the silences are just as important as the sounds in a piece like this. Having things playing constantly can easily feel crowded.</li>
<li>Play with different instruments from the Sonatina library or from elsewhere.</li>
<li>How about mixing two or more instruments in the same system? Maybe add more loops to accommodate them.</li>
<li>Change the musical chords played. For example, playing a straightforward <a href="https://en.wikipedia.org/wiki/C_major">C major scale</a> will result in a very different mood than what we have currently.</li>
<li>Try different impulse responses to change the physical "space" in which the sound plays.</li>
<li>Try randomizing the loop durations and/or delays, so that a <em>different</em> system is generated every time the page loads.</li>
</ul>

<p>Here's an example of a variation I came up with. I used the grand piano but <em>accidentally divided the playback rates of the samples by three</em>, causing them to sound completely different from what I was expecting.</p>

<div class="player-area">
  <h4>"Music for Airports" - Oblique Piano</h4>
  <div class="player musicforairports-variation-oblique">
    <canvas class="spinners" width="650" height="650" style="cursor: pointer; width: 100%"></canvas>
  </div>
</div>

<p>The result not only sounds nothing like a grand piano, but also changes the <em>chord</em>. As we've seen, frequencies and musical notes have an exponential relationship, so when I simply divide the frequency (= playback rate) by a constant number, a new set of musical intervals forms. I don't even know what they are in this case, but I like them.</p>

<p>What essentially happened here is that I caused a bug and it made the thing better. When's the last time you remember that happening? Yet this is the kind of thing that often happens when you're playing around with these kinds of musical systems. It's a good idea to listen carefully when it does, because what you did by mistake may end up sounding better than the thing you were originally trying to do. As one of Eno's <a href="https://en.wikipedia.org/wiki/Oblique_Strategies">Oblique Strategies</a> cards says, <em>"Honor thy error as a hidden intention"</em>.</p>

<p>In another variation I switched the instrument to the English horn, which is also included in the Sonatina sample library:</p>

<div class="player-area">
  <h4>"Music for Airports" - Cor Anglais</h4>
  <div class="player musicforairports-variation-coranglais">
    <canvas class="spinners" width="650" height="650" style="cursor: pointer; width: 100%"></canvas>
  </div>
</div>

<h2 id="brian-enodiscreet-music1975"><div class="piece"><div class="artist">Brian Eno</div><div class="title">Discreet Music</div><div class="year">1975</div></div></h2>

<blockquote cite="./JavaScript Systems Music_files/brian-eno">
  I’ve met a lot of children who were born listening to one record in particular, which is Discreet Music. I should think by now I’ve met about 60 or 70 kids who came out of the womb listening to that record, which of course, is any marketing department's dream: Get in there right at the beginning, you know?
  <footer>Brian Eno, <a href="./JavaScript Systems Music_files/brian-eno">2013</a></footer>
</blockquote>

<p>While the second track on "Music for Airports" is possibly the simplest of Eno's systems music releases, it was not the first. That honor is bestowed on <a href="https://en.wikipedia.org/wiki/Discreet_Music">Discreet Music</a>, recorded several years earlier, on one spring day in 1975.</p>

<p>It wasn't called "ambient" at the time (one <a href="http://www.trouserpress.com/entry.php?a=brian_eno">contemporary review</a> just called it <em>"a haunting minimalist experiment"</em>), but it's still a landmark piece in the development of ambient music, just as much as Music for Airports is.</p>

<div class="vid">
  <iframe width="100%" height="315" src="./JavaScript Systems Music_files/LOpRj927vRc.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>"Discreet Music" is very explicitly a piece of systems music. In fact, Eno actually described the system that produced the music in the liner notes of the album release, and also included a diagram of how the whole thing was put together. This shows how central the "systems" idea was in his thinking at the time.</p>

<figure>
  <a href="https://www.flickr.com/photos/astrangelyisolatedplace/24348004775"><img src="./JavaScript Systems Music_files/discreet_music.jpg"></a>
  <figcaption>Brian Eno included a systems diagram in the liner notes of the Discreet Music record.</figcaption>
</figure>

<p>As we see here, and as we also hear from the results, this system is much more elaborate than the simple tape loops we've been studying so far. There are familiar things such as tapes and loops, but there are also new things such as synthesized sound. It'll take a bit more effort for us to reconstruct, but we'll get there!</p>

<h3 id="setting-up-discreetmusic-js">Setting up <code>discreetmusic.js</code></h3>

<div class="aside">
  <p>
    The source code for this project is <a href="https://github.com/teropa/discreetmusic.js">available on GitHub</a>.
  </p>
</div>

<p>Let's set up a new project for our rendition of Discreet Music. Its structure is the same as in our other projects. Create a new directory and add two files to it:</p>

<ul>
<li><code>discreetmusic/</code>

<ul>
<li><code>index.html</code></li>
<li><code>discreetmusic.js</code></li>
</ul></li>
</ul>

<p>Then set the contents of <code>index.html</code> as follows:</p>

<pre class="hljs "><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.rawgit.com/mohayonao/web-audio-api-shim/master/build/web-audio-api-shim.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://tonejs.github.io/CDN/r7/Tone.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"discreetmusic.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</pre>

<pre class="ws-hack"></pre>

<p>The contents of this file are the same as before, except that this time we're including the <a href="https://github.com/Tonejs/Tone.js">Tone.js library</a> onto the page. This is a fantastic open source JavaScript library that provides all kinds of useful abstractions on top of the standard Web Audio API. We'll use it in several places as we construct this project.</p>

<p>We can now launch our dev server from this directory and start playing with it:</p>

<pre class="hljs ">lite-server
</pre>

<h3 id="synthesizing-the-sound-inputs">Synthesizing the Sound Inputs</h3>

<p>In the pieces we've looked at previously, all sounds have been sampled human voices or musical instruments. Discreet Music is very different in the sense that all sounds are <em>electronically produced</em> with a synthesizer – something that was still pretty exotic in the mid-70s. Eno synthesized the music with his <a href="https://en.wikipedia.org/wiki/EMS_Synthi_AKS">EMS Synthi AKS</a> modular analog synthesizer.</p>

<figure>
  <img src="./JavaScript Systems Music_files/EMS_Synthi_AKS.jpg">
  <figcaption>The EMS Synthi AKS modular - the model Eno used to make Discreet Music and many other things. Photo: <a href="https://commons.wikimedia.org/wiki/File:EMS_Synthi_AKS_through_a_Phaser_Spiral-48.jpg">Andrés Galeotti</a></figcaption>
</figure>

<p>The Synthi was Eno's workhorse for much of the 1970s, and it can be heard not only on Eno's own albums but also on many collaborations. It is all over David Bowie's <a href="https://en.wikipedia.org/wiki/Berlin_Trilogy">Berlin trilogy</a>, for example. The device had a convenient portable form factor: It was built into a briefcase that you could take with you, kind of like a laptop.</p>

<div class="aside">
  <p>There's a neat <a href="https://github.com/AlexNisnevich/synthi-js">JavaScript emulator</a> of the Synthi too, though it doesn't have the keyboard or the sequencer.</p>
</div>

<p>Now, the thing about old analog synthesizers is that they all have distinct sounds. In these machines, sound signals were not treated in the exact digital form as they mostly are today, but were passed along in analog form through all kinds of electronic circuitry. This meant that the signals were subject to various subtle imperfections and disturbances of the physical world, causing each model to have its unique brand of wobble and distortion.</p>

<p>The EMS Synthi is no exception to this. We're not going to be able to emulate exactly what it produces, so we're not going to even try. Instead, we'll settle for something that sounds close enough, for some definition of "close".</p>

<p>The Web Audio API includes all the requisite parts for doing modular synthesis. It supports <a href="https://developer.mozilla.org/en-US/docs/Web/API/OscillatorNode">oscillators</a> for producing sound waves, <a href="https://developer.mozilla.org/en-US/docs/Web/API/BiquadFilterNode">filters</a> for filtering them, and all kinds of other processing nodes for further modifying the sounds, some of which we've already used in this guide.</p>

<p>But the thing is, these APIs are pretty low level. Setting up a synthesizer that approaches the capabilities of a real-world one would require quite a bit of code if we were to do it all directly with Web Audio nodes. This is where <a href="https://github.com/Tonejs/Tone.js">Tone.js</a> comes in. Among the things it includes are abstractions over most of the low-level details of modular synths, allowing us to build different kinds easily.</p>

<p>The following steps demonstrate the construction of a particular synth sound that I came up with for this project. Obviously, there's a huge amount of possible variation here and you'll be able to come up with all kinds of different sounds by tweaking the parameters and trying different kinds of synths. This is especially true if you know your way around sound synthesis.</p>

<h4 id="setting-up-a-monophonic-synth-with-a-sawtooth-wave">Setting up a Monophonic Synth with a Sawtooth Wave</h4>

<p>The first thing we'll do is set up a simple Tone.js <a href="https://tonejs.github.io/docs/#MonoSynth">MonoSynth</a> object. This is a <em>monophonic</em> synthesizer, just like the EMS Synthi, which means it's able to produce one sound at a time.</p>

<p>We'll then connect the synth to the Tone.js <a href="https://tonejs.github.io/docs/#Master">Master output</a> and play a <a href="https://en.wikipedia.org/wiki/C_(musical_note)#Middle_C">middle C note</a> with a duration of one second, so that we can hear what it sounds like.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-synth-monosquare"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.MonoSynth();
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<div class="aside">
  <p>
    Although we can't really see it, what we've constructed here is a Web Audio node graph. It lives inside an <code>AudioContext</code> that Tone.js has constructed for us, and outputs to its destination node.
  </p>
</div>

<p>The sound here is based on a square wave (<img width="100" src="./JavaScript Systems Music_files/square-sparkline.png">), which is the default for MonoSynth. Let's change it to a sawtooth wave (<img width="100" src="./JavaScript Systems Music_files/sawtooth-sparkline.png">). This will result in a very different kind of sound:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-synth-sawtooth"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.MonoSynth(<span class="codeblock-highlight">{
  oscillator: {type: <span class="hljs-string">'sawtooth'</span>}
}</span>);
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<h4 id="filtering-the-wave">Filtering the Wave</h4>

<p>Though the sawtooth wave we have right now is a good start, its sharpness bares no resemblance to the warm synth washes of Discreet Music. We can get much closer to that by <em>filtering</em> the wave with a <a href="https://en.wikipedia.org/wiki/Low-pass_filter">low-pass filter</a>. This will take out some of the higher frequencies of the wave, leaving us with a very different, softer sound (<img width="100" src="./JavaScript Systems Music_files/filtered-sawtooth-sparkline.png">).</p>

<p>The MonoSynth comes with a built-in filtering capability. All we need to do is tweak its <a href="https://tonejs.github.io/docs/#FrequencyEnvelope">FrequencyEnvelope</a>. If we allow the filter to pass just two octaves worth of frequencies above a base frequency of 200Hz, we get a "muffled" sound that's much closer to what we want:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-synth-sawtooth-filtered"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.MonoSynth({
  oscillator: {type: <span class="hljs-string">'sawtooth'</span>}<span class="codeblock-highlight">,
  filterEnvelope: {
    baseFrequency: <span class="hljs-number">200</span>,
    octaves: <span class="hljs-number">2</span>
  }</span>
});
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<p>As you listen to this sound, you may notice that it changes during its lifetime. This is because the filter is actually taking on different values over time, based on the default values of its <a href="https://en.wikipedia.org/wiki/Synthesizer#Attack_Decay_Sustain_Release_.28ADSR.29_envelope">Attack-Decay-Sustain-Release</a> ("ADSR") envelope. In particular, the filter takes a while to kick in and then a bit more time to stabilize because of its <code>attack</code> and <code>decay</code> settings. We don't want that for what we're doing, so let's set those both to zero, so that the filter reaches its <em>sustain</em> level immediately:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-synth-sawtooth-filtered-immediately"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.MonoSynth({
  oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
  filterEnvelope: {
    baseFrequency: <span class="hljs-number">200</span>,
    octaves: <span class="hljs-number">2</span><span class="codeblock-highlight">,
    attack: <span class="hljs-number">0</span>,
    decay: <span class="hljs-number">0</span></span>
  }
});
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<h4 id="tweaking-the-amplitude-envelope">Tweaking the Amplitude Envelope</h4>

<p>Our synth currently starts playing at pretty much full volume immediately, and also ends very quickly once it's <em>released</em> after one second. In Discreet Music both of these sound softer: Synths don't come in quite so abruptly and also linger for a while before they go. Some of this is due to the echo effect we'll add later, but some of it we'll build right into the synth, by changing its <em>amplitude</em> ADSR envelope.</p>

<p>Firstly, if we set the <code>attack</code> to <code>0.1</code>, the sound will "ramp up" for a tenth of a second as it begins:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-synth-with-attack"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.MonoSynth({
  oscillator: {type: <span class="hljs-string">'sawtooth'</span>}<span class="codeblock-highlight">,
  envelope: {
    attack: <span class="hljs-number">0.1</span>
  },</span>
  filterEnvelope: {
    baseFrequency: <span class="hljs-number">200</span>,
    octaves: <span class="hljs-number">2</span>,
    attack: <span class="hljs-number">0</span>,
    decay: <span class="hljs-number">0</span>
  }
});
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<p>Secondly, if we set the <code>release</code> of the synth to happen over a linear curve of four seconds, we get a very slow fading out of the sound after it's released.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-synth-with-attack-release"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.MonoSynth({
  oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
  envelope: {
    attack: <span class="hljs-number">0.1</span><span class="codeblock-highlight">,
    release: <span class="hljs-number">4</span>,
    releaseCurve: <span class="hljs-string">'linear'</span></span>
  },
  filterEnvelope: {
    baseFrequency: <span class="hljs-number">200</span>,
    octaves: <span class="hljs-number">2</span>,
    attack: <span class="hljs-number">0</span>,
    decay: <span class="hljs-number">0</span>
  }
});
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<p>This doesn't sound quite right though - the sound is muting out almost immediately instead of going out evenly over four seconds. This is because of our filter: It also has a <code>release</code> setting, which causes the filter frequency to drop to the base value of <code>200Hz</code>. We don't want that, so let's go ahead and eliminate the filter's release by setting it to a very high number, meaning that it'll happen over such a long period of time that we'll never hear it.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-synth-with-attack-release-filter-fix"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.MonoSynth({
  oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
  envelope: {
    attack: <span class="hljs-number">0.1</span>,
    release: <span class="hljs-number">4</span>,
    releaseCurve: <span class="hljs-string">'linear'</span>
  },
  filterEnvelope: {
    baseFrequency: <span class="hljs-number">200</span>,
    octaves: <span class="hljs-number">2</span>,
    attack: <span class="hljs-number">0</span>,
    decay: <span class="hljs-number">0</span>,
    <span class="codeblock-highlight">release: <span class="hljs-number">1000</span></span>
  }
});
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<p>That's more like it!</p>

<h4 id="bringing-in-a-second-oscillator">Bringing in a Second Oscillator</h4>

<p>The current sound we have is based on a single filtered sawtooth oscillator. We can gain a fuller sound if we combine it with a <em>second</em> oscillator producing a different kind of wave, such as a sine wave (<img width="100" src="./JavaScript Systems Music_files/sine-sparkline.png">).</p>

<p>We could set up another <code>MonoSynth</code> for this purpose and play both synths simultaneously. But we won't have to, since Tone.js comes with a suitable abstraction for this: <a href="https://tonejs.github.io/docs/#DuoSynth">DuoSynth</a> packages two MonoSynths behind a convenient interface for controlling both at the same time.</p>

<p>Here's a DuoSynth, where the first voice is the MonoSynth we constructed before, and the second voice produces a sine wave. Both voices use the same amplitude and filter envelopes.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-duo-synth"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="codeblock-highlight"><span class="hljs-keyword">new</span> Tone.DuoSynth({
  voice0: {
    oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
    envelope: {
      attack: <span class="hljs-number">0.1</span>,
      release: <span class="hljs-number">4</span>,
      releaseCurve: <span class="hljs-string">'linear'</span>
    },
    filterEnvelope: {
      baseFrequency: <span class="hljs-number">200</span>,
      octaves: <span class="hljs-number">2</span>,
      attack: <span class="hljs-number">0</span>,
      decay: <span class="hljs-number">0</span>,
      release: <span class="hljs-number">1000</span>
    }
  },
  voice1: {
    oscillator: {type: <span class="hljs-string">'sine'</span>},
    envelope: {
      attack: <span class="hljs-number">0.1</span>,
      release: <span class="hljs-number">4</span>,
      releaseCurve: <span class="hljs-string">'linear'</span>
    },
    filterEnvelope: {
      baseFrequency: <span class="hljs-number">200</span>,
      octaves: <span class="hljs-number">2</span>,
      attack: <span class="hljs-number">0</span>,
      decay: <span class="hljs-number">0</span>,
      release: <span class="hljs-number">1000</span>
    }
  }
});</span>
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<p>Since both synths use the same envelopes, we can pull them out into variables so we don't have to repeat all their values twice:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-duo-synth-refactored"><button style="float: right;">Play</button><span class="codeblock-highlight"><span class="hljs-keyword">let</span> envelope = {
  attack: <span class="hljs-number">0.1</span>,
  release: <span class="hljs-number">4</span>,
  releaseCurve: <span class="hljs-string">'linear'</span>
};
<span class="hljs-keyword">let</span> filterEnvelope = {
  baseFrequency: <span class="hljs-number">200</span>,
  octaves: <span class="hljs-number">2</span>,
  attack: <span class="hljs-number">0</span>,
  decay: <span class="hljs-number">0</span>,
  release: <span class="hljs-number">1000</span>
};</span>

<span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.DuoSynth({
  voice0: {
    oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
    <span class="codeblock-highlight">envelope,</span>
    <span class="codeblock-highlight">filterEnvelope</span>
  },
  voice1: {
    oscillator: {type: <span class="hljs-string">'sine'</span>},
    <span class="codeblock-highlight">envelope,</span>
    <span class="codeblock-highlight">filterEnvelope</span>
  }
});
synth.toMaster();
synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
</pre>

<p>We can hear the two synths now but the sound is not quite right. There's a kind of eerie quality to it, which is  a combination of two things: Vibrato (which we'll look at next), and the fact that the two oscillators are not vibrating at the same frequency.</p>

<p>The <code>DuoSynth</code> has a <code>harmonicity</code> attribute that controls the difference between the frequencies of the two oscillators. By default it's set to <code>2</code>, causing the second voice to vibrate twice as frequently as (or "an octave above") the first one. While this is nice for many situations, we don't want that right now. We can disable it by setting <code>harmonicity</code> to <code>1</code> so that both oscillators have the same frequency and are playing exactly the same note.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-duo-synth-unison"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.DuoSynth({
  <span class="codeblock-highlight">harmonicity: <span class="hljs-number">1</span>,</span>
  voice0: {
    oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
    envelope,
    filterEnvelope
  },
  voice1: {
    oscillator: {type: <span class="hljs-string">'sine'</span>},
    envelope,
    filterEnvelope
  }
});
</pre>

<h4 id="emulating-tape-wow-with-vibrato">Emulating Tape Wow with Vibrato</h4>

<p>The other extra quality in our sound that was introduced by the DuoSynth is a <a href="https://en.wikipedia.org/wiki/Vibrato">vibrato effect</a>, making the sound's pitch oscillate slightly around the base tone.</p>

<p>While we don't exactly want vibrato in our synth, we can exploit the same feature to emulate something else: Eno's equipment caused some <a href="https://en.wikipedia.org/wiki/Wow_(recording)">tape wow</a> in the original piece, adding continuous slowly changing pitch shifts into the recording. What we can do is add a very slow and very slight vibrato to our synth to emulate a similar effect. It's a pale imitation of the warm analog flutter of the original, but I find it a nice touch anyway.</p>

<p>I found a frequency of 0.5Hz and an depth of 0.1 suitable for this. What we want is an <em>almost</em> imperceptible effect – enough that you hear a difference but not so much that it draws attention to itself.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs has-player player-duo-synth-wow"><button style="float: right;">Play</button><span class="hljs-keyword">let</span> synth = <span class="hljs-keyword">new</span> Tone.DuoSynth({
  harmonicity: <span class="hljs-number">1</span>,
  voice0: {
    oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
    envelope,
    filterEnvelope
  },
  voice1: {
    oscillator: {type: <span class="hljs-string">'sine'</span>},
    envelope,
    filterEnvelope
  }<span class="codeblock-highlight">,
  vibratoRate: <span class="hljs-number">0.5</span>,
  vibratoAmount: <span class="hljs-number">0.1</span></span>
});
</pre>

<p>This synth is now something we can work with.</p>

<h3 id="understanding-timing-in-tone-js">Understanding Timing in Tone.js</h3>

<p>Before we start building up the melodies that we're going to play with our synth, let's talk a little bit about how exactly we're going to control the <em>timing</em> of those melodies.</p>

<p>In the "Music for Airports" system we simply used JavaScript's built-in <code>setInterval()</code> function to make things repeat at (<a href="http://ejohn.org/blog/how-javascript-timers-work/">almost</a>) regular intervals. With this system we have more things to control than just a few virtual tape loops. We need a better API than <code>setInterval()</code> for timing them.</p>

<p>This is another place where Tone.js can help, and it can do so in a couple of ways.</p>

<h4 id="transport-time">Transport Time</h4>

<p>Tone.js has <a href="https://github.com/Tonejs/Tone.js/wiki/TransportTime">its own timeline</a>, along which things can be scheduled to occur over time. For example, we could construct a <a href="https://tonejs.github.io/docs/#Loop">Loop</a> to achieve something very similar as <code>setInterval()</code>: To execute a callback function every 2 seconds.</p>

<pre class="hljs "><span class="hljs-keyword">new</span> Tone.Loop(() =&gt; {
  synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>);
}, <span class="hljs-number">2</span>).start();

<span class="hljs-comment">// Tone's Transport needs to be started for any loops to become active</span>
Tone.Transport.start();
</pre>

<p>But there's a lot more to the Loop API than this. For example, you can set a loop to only repeat a specific number of times, or add some randomness by only having the loop trigger at a given probability. Most importantly though, the loop API lets us do <em>precise timing</em>.</p>

<p>Because of the single-threaded nature of JavaScript, there is no way to guarantee that a given callback function is invoked at an exact moment in time. There is a clever way for us to get around this with Tone.js:</p>

<ol>
<li>Tone.js always executes Loop callbacks <strong>slightly before</strong> their scheduled triggering time.</li>
<li>It passes each callback one argument: The exact <code>time</code> it was <strong>supposed</strong> to be executed at. Because of (1) this will always be a little bit in the future.</li>
<li>We use that <code>time</code> argument when we play our synth. For example, we can give <code>triggerAttackRelease</code> a third argument to control <em>when</em> it should trigger.</li>
</ol>

<figure class="diagram" style="max-width: 550px">
  <img src="./JavaScript Systems Music_files/tone-js-loop-timing.png">
  <figcaption>Tone.js invokes a loop callback slightly before its scheduled time and gives it the scheduled time as an argument.</figcaption>
</figure>

<p>This lets us play a sound at an <em>exact</em> interval:</p>

<pre class="hljs "><span class="hljs-keyword">new</span> Tone.Loop(<span class="codeblock-highlight">time</span> =&gt; {
  synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>, <span class="codeblock-highlight">time</span>);
}, <span class="hljs-number">2</span>).start();

Tone.Transport.start();
</pre>

<h4 id="musical-timing">Musical Timing</h4>

<p>Scheduling things to happen over seconds and milliseconds is one thing, but it's not how most music in the world is measured. Instead, we measure things using <a href="https://en.wikipedia.org/wiki/Time_signature">time signatures</a>: Beats and measures.</p>

<p>In Tone.js we can <a href="https://github.com/Tonejs/Tone.js/wiki/Time">use these <em>musical time signatures</em></a> instead of absolute times to schedule things.  For example, we can schedule a loop to execute once per every <em>measure</em> (or "bar") with the <code>1m</code> syntax where <code>m</code> is short for "measure":</p>

<pre class="hljs "><span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
  synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-number">1</span>, time);
}, <span class="hljs-string">'1m'</span>).start();

Tone.Transport.start();
</pre>

<p>In Tone's default 4/4 time signature (which is what we're going to use), this will happen every four beats (<strong>ONE</strong>-two-three-four-<strong>ONE</strong>-two-three-four).</p>

<p>We can also divide the measure into half notes (<code>2n</code>), quarter notes (<code>4n</code>), eighth notes (<code>8n</code>), and sixteenth notes (<code>16n</code>). We can play a note, say, on the second beat of every measure by delaying the trigger by one quarter note (one-<strong>TWO</strong>-three-four-one-<strong>TWO</strong>-three-four):</p>

<pre class="hljs "><span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
  <span class="hljs-comment">// Trigger one quarter note from now, and hold for one eighth note</span>
  synth.triggerAttackRelease(<span class="hljs-string">'C4'</span>, <span class="hljs-string">'8n'</span>, <span class="hljs-string">'+4n'</span>);
}, <span class="hljs-string">'1m'</span>).start();

Tone.Transport.start();
</pre>

<p>When we want to combine different measures, we can use simple arithmetic expressions (<code>'1m + 16n'</code>), or use a special shorthand "<code>measures:quarters:sixteenths</code>" syntax:</p>

<ul>
<li><code>1:1:1</code> = <code>1m + 4n + 16n</code></li>
<li><code>0:0:2</code> = <code>2 * 16n</code> = <code>8n</code></li>
<li><code>0:1:2</code> = <code>4n + 2 * 16n</code> = <code>4n + 8n</code></li>
<li><code>1:2:3</code> = <code>1m + 2 * 4n + 3 * 16n</code> = <code>1m + 2n + 8n + 16n</code></li>
</ul>

<p>Perhaps the most useful part about using musical timing from our point of view is that using this scheme, the <em>absolute timing of events can be changed</em> by setting the BPM (beats-per-minute) value of the transport. For example, we can make <em>everything</em> in our system play in double speed by bumping the BPM from the default of 120 to 240;</p>

<pre class="hljs ">Tone.Transport.bpm.value = <span class="hljs-number">240</span>;
</pre>

<p>This, in fact, is a trick Brian Eno commonly uses: He often works on his ambient pieces at double speed and then slows them down before release. This was also the case with Discreet Music. It's not simply about working at a faster pace, but about affecting how the results turn out:</p>

<blockquote cite="./JavaScript Systems Music_files/melma80b.html">
  I have a theory that, as a maker you tend to put in twice as much as you need as a listener. You tend to plug every hole. You're always looking for that charge, so you put more and more in to get it. But as a listener you're much less demanding. You can take things that are much simpler, much more open, and much slower.
  <br><br>
  It's often happened that I've made a piece and ended up slowing it down by as much as half. Discreet Music is an example: that's half the speed at which it was recorded.
  <footer>Brian Eno, <a href="./JavaScript Systems Music_files/melma80b.html">1979</a></footer>
</blockquote>

<p>As you work on this piece, you may want to double the Transport BPM to get a feel for the speed at which Eno actually worked on it.</p>

<h3 id="sequencing-the-synth-loops">Sequencing the Synth Loops</h3>

<p>At the core of Discreet Music is an assortment of little melodic phrases, played with a synth similar to the one we've just constructed. If you listen to the original, you'll hear some of them playing somewhat to the left of center in the stereo field and some to the right. These seven phrases form <em>all</em> the sonic inputs to the system:</p>

<table>
  <tbody><tr>
    <th>Left</th>
    <th>Right</th>
  </tr><tr>
  </tr><tr>
    <td>
      <button class="play-phrase" data-phrase="C5-D5" data-pan="left">▶ C5 D5</button>
    </td>
    <td><button class="play-phrase" data-phrase="D4-E4" data-pan="right">▶ D4 E4</button></td>
  </tr>
  <tr>
    <td><button class="play-phrase" data-phrase="E4" data-pan="left">▶ E4</button></td>
    <td><button class="play-phrase" data-phrase="B3-G3" data-pan="right">▶ B3 G3</button></td>
  </tr>
  <tr>
    <td><button class="play-phrase" data-phrase="G4" data-pan="left">▶ G4</button></td>
    <td><button class="play-phrase" data-phrase="G4" data-pan="right">▶ G4</button></td>
  </tr>
  <tr>
    <td><button class="play-phrase" data-phrase="E5-G5-A5-G5" data-pan="left">▶ E5 G5 A5 G5</button></td>
    <td></td>
  </tr>
</tbody></table>

<style type="text/css">
.play-phrase {
  width: 160px;
  text-align: left;
}
</style>

<p>These phrases are arranged onto two repeating sequences that have slightly different durations: One for the left channel, and one for the right. Both sequences are looped. The result of this is yet another instance of a phasing loop system, the kind of which we've seen already. As the two loops repeat they form different combinations over time.</p>

<p>Since the two sequences use different stereo panning, and may also play at the same time because of the phasing that's going on, we can't really use the same MonoSynth for both. We need two synths, and we need to pan them separately. Let's extract our synth initialization code into a function that we can then call twice to make two identical synths.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="codeblock-highlight"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeSynth</span>(<span class="hljs-params"></span>) </span>{</span>
  <span class="hljs-keyword">let</span> envelope = {
    attack: <span class="hljs-number">0.1</span>,
    release: <span class="hljs-number">4</span>,
    releaseCurve: <span class="hljs-string">'linear'</span>
  };
  <span class="hljs-keyword">let</span> filterEnvelope = {
    baseFrequency: <span class="hljs-number">200</span>,
    octaves: <span class="hljs-number">2</span>,
    attack: <span class="hljs-number">0</span>,
    decay: <span class="hljs-number">0</span>,
    release: <span class="hljs-number">1000</span>
  };

  <span class="codeblock-highlight"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword">new</span> Tone.DuoSynth({
    harmonicity: <span class="hljs-number">1</span>,
    voice0: {
      oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
      envelope,
      filterEnvelope
    },
    voice1: {
      oscillator: {type: <span class="hljs-string">'sine'</span>},
      envelope,
      filterEnvelope
    },
    vibratoRate: <span class="hljs-number">0.5</span>,
    vibratoAmount: <span class="hljs-number">0.1</span>
  });
<span class="codeblock-highlight">}</span>

<span class="codeblock-highlight"><span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();</span>
</pre>

<p>We'll then set up two Tone.js <a href="https://tonejs.github.io/docs/#Panner">Panners</a> (which are pretty much just wrappers for the Web Audio StereoPannerNode that we've already seen). We connect each synth to a panner and set the panners to opposite locations of the stereo field:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();

<span class="codeblock-highlight"><span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>).toMaster();
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>).toMaster();

leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);</span>
</pre>

<p>We're setting the pannings to -0.5 and 0.5, putting them to the left and right of center, but not fully to the left and right so that some mixing of channels will occur.</p>

<p>Eno's Synthi AKS had a primitive sequencer (which he called a "digital recall system" at the time) onto which the sequences were programmed. What we can do to substitute for this is to model each sequence as a Tone.js <a href="https://tonejs.github.io/docs/#Loop">Loop</a>. We have one Loop for the left synth, and one for the right:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();

<span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>).toMaster();
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>).toMaster();

leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);

<span class="codeblock-highlight"><span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
  <span class="hljs-comment">// We'll play leftSynth here</span>
}, <span class="hljs-string">'34m'</span>).start();

<span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
  <span class="hljs-comment">// We'll play rightSynth here</span>
}, <span class="hljs-string">'37m'</span>).start();

Tone.Transport.start();</span>
</pre>

<p>With the default BPM of 120 and time signature of 4/4, the left loop's wall clock duration will be about 68 seconds, and the right loop's 74 seconds. This is roughly the same as in the original Discreet Music. Since the loops have different durations, the resulting phasing effect causes the sounds to shift relative to each other over time, just like in "It's Gonna Rain" and "Airports". In this case there'll be about 41 minutes of unique music before the loops start at the same time again.</p>

<p>Here's what the audio graph of this system looks like:</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-discreet-panned-synths.png">
  <figcaption>The Web Audio graph of two panned synths. The Tone DuoSynths and Panners are abstractions. Under the hood, each DuoSynth contains several oscillator, gain, and filter nodes.</figcaption>
</figure>

<p>Let's put the first melodic phrase of the left loop in. It triggers the C5 note, and then moves to the D5 note, and starts right at the beginning of the loop:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
<span class="codeblock-highlight">  <span class="hljs-comment">// Trigger C5, and hold for a full note (measure) + two 1/4 notes</span>
  leftSynth.triggerAttackRelease(<span class="hljs-string">'C5'</span>, <span class="hljs-string">'1:2'</span>, time);
  <span class="hljs-comment">// Switch note to D5 after two 1/4 notes without retriggering</span>
  leftSynth.setNote(<span class="hljs-string">'D5'</span>, <span class="hljs-string">'+0:2'</span>);</span>
}, <span class="hljs-string">'34m'</span>).start();

<span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
  <span class="hljs-comment">// We'll play rightSynth here</span>
}, <span class="hljs-string">'37m'</span>).start();
</pre>

<p>This phrase will play right when the page loads. It then repeats after just over a minute when the loop turns.</p>

<p>We can then fill in the rest of the phrases of the left sequence:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
  leftSynth.triggerAttackRelease(<span class="hljs-string">'C5'</span>, <span class="hljs-string">'1n + 2n'</span>, time);
  leftSynth.setNote(<span class="hljs-string">'D5'</span>, <span class="hljs-string">'+2n'</span>);

<span class="codeblock-highlight">  <span class="hljs-comment">// Trigger E4 after 6 measures and hold for two 1/4 notes.</span>
  leftSynth.triggerAttackRelease(<span class="hljs-string">'E4'</span>, <span class="hljs-string">'0:2'</span>, <span class="hljs-string">'+6:0'</span>);

  <span class="hljs-comment">// Trigger G4 after 11 measures + a two 1/4 notes, and hold for two 1/4 notes.</span>
  leftSynth.triggerAttackRelease(<span class="hljs-string">'G4'</span>, <span class="hljs-string">'0:2'</span>, <span class="hljs-string">'+11:2'</span>);

  <span class="hljs-comment">// Trigger E5 after 19 measures and hold for 2 measures.</span>
  <span class="hljs-comment">// Switch to G5, A5, G5 after delay of a 1/4 note + two 1/16 notes each.</span>
  leftSynth.triggerAttackRelease(<span class="hljs-string">'E5'</span>, <span class="hljs-string">'2:0'</span>, <span class="hljs-string">'+19:0'</span>);
  leftSynth.setNote(<span class="hljs-string">'G5'</span>, <span class="hljs-string">'+19:1:2'</span>);
  leftSynth.setNote(<span class="hljs-string">'A5'</span>, <span class="hljs-string">'+19:3:0'</span>);
  leftSynth.setNote(<span class="hljs-string">'G5'</span>, <span class="hljs-string">'+19:4:2'</span>);</span>
}, <span class="hljs-string">'34m'</span>).start();
</pre>

<p>The math here can be a bit tricky to follow because we're talking in musical measures and not absolute times.  But if you play with the numbers and listen to the results you can get the hang of it pretty quickly.</p>

<p>And then we'll do the same for the right sequence, which will complete all the synth inputs to the system. Here's the full source code so far.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeSynth</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">let</span> envelope = {
    attack: <span class="hljs-number">0.1</span>,
    release: <span class="hljs-number">4</span>,
    releaseCurve: <span class="hljs-string">'linear'</span>
  };
  <span class="hljs-keyword">let</span> filterEnvelope = {
    baseFrequency: <span class="hljs-number">200</span>,
    octaves: <span class="hljs-number">2</span>,
    attack: <span class="hljs-number">0</span>,
    decay: <span class="hljs-number">0</span>,
    release: <span class="hljs-number">1000</span>
  };

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Tone.DuoSynth({
    harmonicity: <span class="hljs-number">1</span>,
    voice0: {
      oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
      envelope,
      filterEnvelope
    },
    voice1: {
      oscillator: {type: <span class="hljs-string">'sine'</span>},
      envelope,
      filterEnvelope
    },
    vibratoRate: <span class="hljs-number">0.5</span>,
    vibratoAmount: <span class="hljs-number">0.1</span>
  });
}

<span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();

<span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>).toMaster();
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>).toMaster();

leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);

<span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
  leftSynth.triggerAttackRelease(<span class="hljs-string">'C5'</span>, <span class="hljs-string">'1:2'</span>, time);
  leftSynth.setNote(<span class="hljs-string">'D5'</span>, <span class="hljs-string">'+0:2'</span>);

  leftSynth.triggerAttackRelease(<span class="hljs-string">'E4'</span>, <span class="hljs-string">'0:2'</span>, <span class="hljs-string">'+6:0'</span>);

  leftSynth.triggerAttackRelease(<span class="hljs-string">'G4'</span>, <span class="hljs-string">'0:2'</span>, <span class="hljs-string">'+11:2'</span>);

  leftSynth.triggerAttackRelease(<span class="hljs-string">'E5'</span>, <span class="hljs-string">'2:0'</span>, <span class="hljs-string">'+19:0'</span>);
  leftSynth.setNote(<span class="hljs-string">'G5'</span>, <span class="hljs-string">'+19:1:2'</span>);
  leftSynth.setNote(<span class="hljs-string">'A5'</span>, <span class="hljs-string">'+19:3:0'</span>);
  leftSynth.setNote(<span class="hljs-string">'G5'</span>, <span class="hljs-string">'+19:4:2'</span>);
}, <span class="hljs-string">'34m'</span>).start();

<span class="hljs-keyword">new</span> Tone.Loop(time =&gt; {
<span class="codeblock-highlight"><span class="hljs-comment">// Trigger D4 after 5 measures and hold for 1 full measure + two 1/4 notes</span>
  rightSynth.triggerAttackRelease(<span class="hljs-string">'D4'</span>, <span class="hljs-string">'1:2'</span>, <span class="hljs-string">'+5:0'</span>);
  <span class="hljs-comment">// Switch to E4 after one more measure</span>
  rightSynth.setNote(<span class="hljs-string">'E4'</span>, <span class="hljs-string">'+6:0'</span>);

  <span class="hljs-comment">// Trigger B3 after 11 measures + two 1/4 notes + two 1/16 notes. Hold for one measure</span>
  rightSynth.triggerAttackRelease(<span class="hljs-string">'B3'</span>, <span class="hljs-string">'1m'</span>, <span class="hljs-string">'+11:2:2'</span>);
  <span class="hljs-comment">// Switch to G3 after a 1/2 note more</span>
  rightSynth.setNote(<span class="hljs-string">'G3'</span>, <span class="hljs-string">'+12:0:2'</span>);

  <span class="hljs-comment">// Trigger G4 after 23 measures + two 1/4 notes. Hold for a half note.</span>
  rightSynth.triggerAttackRelease(<span class="hljs-string">'G4'</span>, <span class="hljs-string">'0:2'</span>, <span class="hljs-string">'+23:2'</span>);</span>
}, <span class="hljs-string">'37m'</span>).start();

Tone.Transport.start();
</pre>

<p>What we have now are two looping sequences, going about their way on their own timings and forming different combinations against each other:</p>

<div class="discreet-sequences player" style="cursor: pointer;">
  <canvas class="sequence1" width="1000" height="100" style="width: 100%"></canvas>
  <canvas class="sequence2" width="1000" height="100" style="width: 100%"></canvas>
</div>

<p>This is starting to resemble Discreet Music, though it does still sound very sparse and not all that interesting. That will change soon.</p>

<div class="aside">
<p>
  I don't know exactly how Eno achieved what we've done here. As far as I can tell, the Synthi AKS could hold just one sequence at a time. Furthermore, it was monophonic so it couldn't play more than one note at a time. It wouldn't seem to be possible to run two sequences of different durations simultaneously.
</p>
<p>
  The best theory I can come up with is that Eno actually ran the system twice – once per each sequence – and simply overdubbed each run to the same master tape.
</p>
</div>

<h3 id="adding-echo">Adding Echo</h3>

<p>The Discreet Music system also contained an echo unit, through which all sounds coming from the synthesizer were routed before they reached the tape. We can simulate this by using a Tone.js <a href="https://tonejs.github.io/docs/#FeedbackDelay">FeedbackDelay</a> node. It takes the incoming signal, holds on to it for a given delay, and then feeds part of it back to the signal again, causing each sound to repeat ("echo") a number of times.</p>

<figure class="diagram" style="max-width: 550px">
  <img src="./JavaScript Systems Music_files/tone-echo-delay.png">
  <figcaption>A FeedbackDelay node partially repeats the incoming signal a number of times. It can be used to construct an echo effect.</figcaption>
</figure>

<p>The node is parameterized with two numbers:</p>

<ul>
<li><code>delayTime</code> - how long the delay should be, or "how long does it take before you hear the echo?"</li>
<li><code>feedback</code> - how much of the input to feed back in, or "how loud is the echo?". This also indirectly controls how many times the signal will be repeated – until it reaches zero.</li>
</ul>

<p>Let's put in a delay time of a sixteenth note and a feedback of 0.2. The delay is connected to the master output, and the panners are now connected to the delay:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>); <span class="hljs-comment">// No longer connected to master!</span>
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>); <span class="hljs-comment">// No longer connected to master!</span>
<span class="codeblock-highlight"><span class="hljs-keyword">let</span> echo = <span class="hljs-keyword">new</span> Tone.FeedbackDelay(<span class="hljs-string">'16n'</span>, <span class="hljs-number">0.2</span>);</span>

leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);
<span class="codeblock-highlight">leftPanner.connect(echo);
rightPanner.connect(echo);
echo.toMaster();</span>
</pre>

<p>Since we are now layering our synth sound on top of itself, it becomes a bit too loud and you may hear some distortion because of this. We can make it more manageable by adjusting the volume of our synths, by something like -20dB:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Tone.DuoSynth({
  harmonicity: <span class="hljs-number">1</span>,
  <span class="codeblock-highlight">volume: <span class="hljs-number">-20</span>,</span>
  voice0: {
    oscillator: {type: <span class="hljs-string">'sawtooth'</span>},
    envelope,
    filterEnvelope
  },
  voice1: {
    oscillator: {type: <span class="hljs-string">'sine'</span>},
    envelope,
    filterEnvelope
  },
  vibratoRate: <span class="hljs-number">0.5</span>,
  vibratoAmount: <span class="hljs-number">0.1</span>
});
</pre>

<p>This is what our system audio graph looks like now:</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-discreet-panned-synths-with-echo.png">
  <figcaption>The Web Audio graph of two panned, echoed synths.</figcaption>
</figure>

<p>And here's how it sounds:</p>

<div class="discreet-sequences-echoed player" style="cursor: pointer;">
  <canvas class="sequence1" width="1000" height="100" style="width: 100%"></canvas>
  <canvas class="sequence2" width="1000" height="100" style="width: 100%"></canvas>
</div>

<div class="aside">
  <p>
    If you listen to <a href="https://www.youtube.com/watch?v=LOpRj927vRc&amp;feature=youtu.be&amp;t=28m30s">the very last minutes of Discreet Music</a>, you'll hear an echo that's much longer and more distinct than before.
  </p>
  <p>
    It sounds like Eno changed the echo delay during recording, which is easily done with <a href="https://en.wikipedia.org/wiki/Echoplex#/media/File:Maestro_Echoplex_EP-4_with_analog_meter_(edit1).jpg">the controls on the Echoplex unit</a> he was using. Should you want to do the same, you can simply adjust the <code>delayTime</code> and <code>feedback</code> attributes our feedback delay (try something like <code>2n</code> and <code>0.4</code>).
  </p>
</div>

<h3 id="adding-tape-delay-with-frippertronics">Adding Tape Delay with Frippertronics</h3>

<p>And now we arrive at the defining feature of the Discreet Music system: A tape delay contortion commonly called <a href="https://en.wikipedia.org/wiki/Frippertronics">Frippertronics</a>.</p>

<p>The basic idea of this system is that whatever sound goes into it is repeated again after a few seconds, and then again after a few seconds more, and again, until it gradually fades out.</p>

<figure class="diagram" style="max-width: 550px">
  <img src="./JavaScript Systems Music_files/frippertronics-repeats.png">
</figure>

<p>Now, this may sound pretty similar to the "echo" feedback delay we just added in the previous section. And that's because that's precisely what it does. It feeds the audio signal back to the system with a delay. The difference is that in this case the delay is very long – several seconds long, in fact. It doesn't sound like an echo. It sounds like a completely new sound that just happens to be a repetition of a sound that occured a few seconds ago.</p>

<p>These days such effects can easily be achieved with digital delays, but in the early 1970s this was not the case. Delay units like the Echoplex could not provide anything close to the delay times we need here. Frippertronics is a very clever hack that gets around this. It involves the same kind of tape recorders we've been discussing with relation to tape loops, but configured a bit differently.</p>

<p>How this works is that you have two tape recorders. You plug your input (the synth, in our case) to one tape recorder, which then records that input onto a tape. But from this tape recorder you then feed the tape directly to the <em>other</em> tape recorder, where it is <em>played back</em>. The output signal of the second tape recorder is fed back into the first as another input, so that it's recorded to the tape again, and this is how it keeps repeating every few seconds.</p>

<figure class="diagram">
  <a href="https://www.flickr.com/photos/astrangelyisolatedplace/24348004775"><img src="./JavaScript Systems Music_files/discreet-music-frippertronics.jpg"></a>
  <figcaption>The Frippertronics tape delay system, as illustrated on the Discreet Music liner notes.</figcaption>
</figure>

<p>So, after a sound is recorded to a tape on the first recorder, the tape travels to the second recorder, and then it is played back there. The exact delay is controlled by the physical distance between the two tape machines, because that directly affects how long the tape takes to travel between them. In the case of Discreet Music, the delay is about six seconds.</p>

<p>Eno and frequent collaborator, Robert Fripp of King Crimson, developed this system for their joint releases, such as <a href="https://en.wikipedia.org/wiki/(No_Pussyfooting)">(No Pussyfooting)</a>. The idea was that Fripp would play things on his guitar and Eno would use the delay system to layer the guitar sound on top of itself.</p>

<div class="aside">
  <p>
    <a href="https://www.youtube.com/watch?v=FCXNxVWx3jY">Here's a nice video introduction</a> to how a Frippertronics system can be set up and used with an electric guitar.
  </p>
</div>

<p>The system wasn't originally Fripp and Eno's invention though: Terry Riley and Pauline Oliveros had experimented with such systems as much as a decade earlier. Riley called it the <a href="http://www.loopers-delight.com/history/Loophist.html">Time Lag Accumulator</a> and recorded pieces like <a href="https://www.youtube.com/watch?v=PzSl1fNgmAE">Poppy Nogood and the Phantom Band</a> with it. Oliveros used similar systems to record some fantastically eerie tape pieces like <a href="https://www.youtube.com/watch?v=8wrNL063Gys">Bye Bye Butterfly</a>.</p>

<p>But how should we approach emulating this kind of tape delay system? We could use a Tone.js <code>FeedbackDelay</code> again, but I think in this case it's more appropriate to drop to the lower level of the native Web Audio API, both because laying bare the internal structure of the system will help understand how it works, and because I feel it's closer to the DIY ethos of the original Frippertronics. As we do this, we'll see that Tone.js integrates well with the lower level Web Audio API nodes, and we can mix and match Tone nodes and raw nodes in the same graph.</p>

<p>The first thing we'll do is create a Web Audio <a href="https://developer.mozilla.org/en-US/docs/Web/API/DelayNode">DelayNode</a>, and set its delay to six seconds, which is about what it is in Discreet Music. We then connect our echo delay to this new delay node. Both the echo delay and the new delay are connected to the audio context destination. Each sound is played right when it comes out of the synth and then repeated again six seconds later.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();
<span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>);
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>);
<span class="hljs-keyword">let</span> echo = <span class="hljs-keyword">new</span> Tone.FeedbackDelay(<span class="hljs-string">'16n'</span>, <span class="hljs-number">0.2</span>);
<span class="codeblock-highlight"><span class="hljs-keyword">let</span> delay = Tone.context.createDelay(<span class="hljs-number">6.0</span>); <span class="hljs-comment">// Borrow the AudioContext from Tone.js</span></span>

<span class="codeblock-highlight">delay.delayTime.value = <span class="hljs-number">6.0</span>;</span>

leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);
leftPanner.connect(echo);
rightPanner.connect(echo);

echo.toMaster();
<span class="codeblock-highlight">echo.connect(delay);
delay.connect(Tone.context.destination);</span>
</pre>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-discreet-panned-synths-with-echo-and-delay.png">
  <figcaption>The Web Audio graph of two panned, echoed synths played twice: Once immediately and once after a delay.</figcaption>
</figure>

<p>With this, the music gets off to a good start, but it's not quite right. Everything repeats twice and then goes away. We want things to stick around longer than that.</p>

<p>The trick is to <em>connect the delay back to itself</em>. That means the sounds will just keep coming back after every 6 seconds.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();
<span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>);
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>);
<span class="hljs-keyword">let</span> echo = <span class="hljs-keyword">new</span> Tone.FeedbackDelay(<span class="hljs-string">'16n'</span>, <span class="hljs-number">0.2</span>);
<span class="hljs-keyword">let</span> delay = Tone.context.createDelay(<span class="hljs-number">6.0</span>);

delay.delayTime.value = <span class="hljs-number">6.0</span>;

leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);
leftPanner.connect(echo);
rightPanner.connect(echo);

echo.toMaster();
echo.connect(delay);
delay.connect(Tone.context.destination);
<span class="codeblock-highlight">delay.connect(delay);</span>
</pre>

<p>What we've done here is formed a <em>loop</em> within the audio node graph.</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-discreet-panned-synths-with-echo-and-looped-delay.png">
  <figcaption>The Web Audio graph of two panned, echoed synths played continuously through a looped delay.</figcaption>
</figure>

<p>This is much better, but now we have another problem. As we listen to the system for a while, it grows into an ear-shattering cacophony of melodies. It does sound <em>interesting</em> but it's not quite what we're after. That's because every sound coming in from the synth never goes away! It keeps looping forever.</p>

<p>What we need is a way to fade the sound out a bit each time it passes through the loop we've made. After each delay it should be a bit quieter than before. We can do this by introducing a <a href="https://developer.mozilla.org/en-US/docs/Web/API/GainNode">GainNode</a> to the loop. It is used to control volume, and what we'll do with it is lower the volume of the signal by a quarter each time it passes through.</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();
<span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>);
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>);
<span class="hljs-keyword">let</span> echo = <span class="hljs-keyword">new</span> Tone.FeedbackDelay(<span class="hljs-string">'16n'</span>, <span class="hljs-number">0.2</span>);
<span class="hljs-keyword">let</span> delay = Tone.context.createDelay(<span class="hljs-number">6.0</span>);
<span class="codeblock-highlight"><span class="hljs-keyword">let</span> delayFade = Tone.context.createGain();</span>

delay.delayTime.value = <span class="hljs-number">6.0</span>;
<span class="codeblock-highlight">delayFade.gain.value = <span class="hljs-number">0.75</span>;</span>

leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);
leftPanner.connect(echo);
rightPanner.connect(echo);

echo.toMaster();
echo.connect(delay);
delay.connect(Tone.context.destination);
<span class="codeblock-highlight">delay.connect(delayFade);
delayFade.connect(delay);</span>
</pre>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-discreet-panned-synths-with-echo-and-looped-delay-with-gain.png">
  <figcaption>The Web Audio graph of a complete Frippertronics system: Two panned, echoed synths played continuously through a looped delay. The delay loop goes through a gain that gradually fades out the repeated signal.</figcaption>
</figure>

<p>That's more like it! Here's what the system we have now sounds like:</p>

<div class="discreet-without-eq player" style="cursor: pointer;">
  <canvas class="frippertronics" width="650" height="650" style="width: 100%"></canvas>
</div>

<h3 id="controlling-timbre-with-a-graphic-equalizer">Controlling Timbre with a Graphic Equalizer</h3>

<p>At this point there's just one more thing for us to do, and it involves the final piece in the Discreet Music  diagram that we haven't addressed yet: The graphic <a href="https://en.wikipedia.org/wiki/Equalization_(audio)">equalizer</a>.</p>

<p>What's meant by this is one of these things – an interface for controlling the volumes of different frequency bands in the audio signal:</p>

<figure>
  <img src="./JavaScript Systems Music_files/graphic_equalizer.png">
  <figcaption>Photo: <a href="https://www.flickr.com/photos/rufflife/5107859078/in/photolist-8Mn7xQ-e1pZkv-aZ7k7H-e1vCV1-8t77B9-5vXxci-6X6r3D-brdxTe-oGAcuP-4iRcZw-aLXmQx-p3HJbp-pibTyb-p3JBTm-pibCVU-a1Hn5-7Ynkk-p3HYcm-488r89-dGV1yE-pibJcA-vgTAK-qXX1LV-pjWwnV-p3JgKq-8kPZjz-7wZSQW-pjWDac-pkbVL1-5KZBY7-iVEy9K-5wiBQd-cinLH-fJc9Yd-7k4qsx-4Xqeaj-p3BU86-8FTrkn-t86Qv-eoL5K2-8SvKEB-dLSmgM-nHszzy-5GzTU-xrsE-5jQuQ4-iCuY5H-5owbA-bU7xgz-5qXXj">Rik Ruff</a></figcaption>
</figure>

<p>The term <strong>graphic</strong> equalizer comes from the neat UI design of this interface: The knobs on each slider not only provide the means to control the volume of a certain frequency band, but also <em>visualize</em> the resulting frequency graph. If you plot a mental curve through the center of each slider knob, you get an idea of the <em>frequency response</em> of the equalizer. No separate graph display is required for that.</p>

<p>There are many reasons one may want to use a graphic equalizer when recording or playing back sound. For most of my lifetime I've used them to just make music sound as loud as possible while listening. But in this case we have a different, very specific purpose: To control the harmonic spectrum of our synthesizers while they're playing, resulting in different <a href="https://en.wikipedia.org/wiki/Timbre">timbres</a>.</p>

<p>The oscillators and filters we've set up for our synth are generating sounds at certain frequencies. Among them are the <em>fundamental frequencies</em> of each note. For example, when we play a C5 pitch, it plays a sound at the fundamental frequency of that pitch, 523.25Hz. But this is not the only frequency played. There are sounds played at a number of frequencies, particularly at certain integer multiples of the fundamental frequency, called <a href="https://en.wikipedia.org/wiki/Harmonic">harmonics</a>.</p>

<figure class="diagram" style="max-width: 600px">
  <img src="./JavaScript Systems Music_files/discreet-harmonics.png">
  <figcaption>Our synth driven through <a href="http://webaudiodemos.appspot.com/oscilloscope/">Chris Wilson's Web Audio Oscilloscope</a>. The lower half of the image shows a frequency breakdown of the sound at a point in time. The leftmost bars display the fundamental frequency, and to the right of them there are several peaks for the various harmonics of the synth. With an equaliser we can manipulate the sound by eliminating or boosting some of those harmonics.</figcaption>
</figure>

<p>The relationships between the fundamental frequency and the harmonics result in the distinct sound of our synth (as they do for any musical instrument).</p>

<p>A graphic equalizer allows us to change these things at runtime. We can, for example, emphasize some harmonics and eliminate others. Or we may bring down the fundamental frequency itself, after which we may start hearing a completely different note!</p>

<p>What's notable about this from the perspective of our discussion is that here Eno introduced some <em>manual inputs</em> to his system, which was otherwise running fully automatically. When you listen to Discreet Music, you'll hear that the sound seems to become distinctly different in certain points. Sometimes its louder, sometimes quieter. Sometimes its thinner, sometimes fuller. What you're hearing is Eno adjusting the controls on his graphic equalizer to different settings during the recording. But that's all he's doing, the system itself is playing automatically.</p>

<p>So, what we're going to do is build a little graphic equalizer UI of our own, which we can then use to control our system as it is playing. We can do so with a bunch of HTML controls which we connect to Web Audio nodes.</p>

<h4 id="setting-up-the-equalizer-filters">Setting up the Equalizer Filters</h4>

<p>We're going to control the <em>gain</em> of the sound signal separately on a number of frequencies. Before we do anything else, let's specify these frequencies in a constant:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">const</span> EQUALIZER_CENTER_FREQUENCIES = [
  <span class="hljs-number">100</span>, <span class="hljs-number">125</span>, <span class="hljs-number">160</span>, <span class="hljs-number">200</span>, <span class="hljs-number">250</span>, <span class="hljs-number">315</span>, <span class="hljs-number">400</span>, <span class="hljs-number">500</span>, <span class="hljs-number">630</span>, <span class="hljs-number">800</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1250</span>,
  <span class="hljs-number">1600</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">2500</span>, <span class="hljs-number">3150</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">6300</span>, <span class="hljs-number">8000</span>, <span class="hljs-number">10000</span>
];
</pre>

<p>These are all hertz values, about 1/3 of an octave apart from each other (remember the exponential relationship between notes and frequencies?). They're called <a href="http://www.kayelaby.npl.co.uk/general_physics/2_4/2_4_3.html">ISO preferred frequencies</a> and you'll find them on most so-called "1/3 octave" equalizers, which are the ones that have a big row of 30-31 knobs on them.</p>

<p>We are not going to use 30 bands in our equalizer though. We only have 21. That's because I've left out some of the lowest and highest frequencies completely. A general purpose graphic equalizer has knobs for the whole audible spectrum of about 20Hz to 20kHz, but our <em>domain specific equalizer</em> only needs to deal with the middle frequencies that are present in Discreet Music. In the interest of user experience we won't add unnecessary controls for the very low and high ends.</p>

<p>What we'll do next is add a <em>filter node</em> for each of these frequencies. Each filter can either boost or hinder that particular frequency.</p>

<p>The Web Audio API comes with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/BiquadFilterNode">BiquadFilterNode</a> interface that allows for signal filtering. There are different kinds of filters available and we can switch between them using the <code>type</code> attribute. The type we need here is <code>peaking</code>: It controls a certain frequency band "peaking" at a specific frequency. Here's how we could create a peaking filter for boosting the 1kHz frequency by 12 decibels:</p>

<pre class="hljs "><span class="hljs-keyword">let</span> filter = Tone.context.createBiquadFilter();
filter.type = <span class="hljs-string">'peaking'</span>;
filter.frequency.value = <span class="hljs-number">1000</span>;
filter.Q.value = <span class="hljs-number">4.31</span>;
filter.gain.value = <span class="hljs-number">12</span>;
</pre>

<p>The <code>Q</code> attribute controls the <em>width</em> of the frequency band around the base frequency. It is defined as "center frequency divided by the desired bandwidth". We always want a bandwidth of a 1/3 octave since that is the distance between our adjacent knobs, and for this <a href="http://www.rane.com/note101.html">4.31 is a convenient magic number</a>.</p>

<p>Now, we have a number of frequencies to control separately, and that means we need a number of individual filter nodes, one for each frequency. Let's create all those nodes:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-keyword">let</span> leftSynth = makeSynth();
<span class="hljs-keyword">let</span> rightSynth = makeSynth();
<span class="hljs-keyword">let</span> leftPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">-0.5</span>);
<span class="hljs-keyword">let</span> rightPanner = <span class="hljs-keyword">new</span> Tone.Panner(<span class="hljs-number">0.5</span>);
<span class="codeblock-highlight"><span class="hljs-keyword">let</span> equalizer = EQUALIZER_CENTER_FREQUENCIES.map(frequency =&gt; {
  <span class="hljs-keyword">let</span> filter = Tone.context.createBiquadFilter();
  filter.type = <span class="hljs-string">'peaking'</span>;
  filter.frequency.value = frequency;
  filter.Q.value = <span class="hljs-number">4.31</span>;
  filter.gain.value = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> filter;
});</span>
<span class="hljs-keyword">let</span> echo = <span class="hljs-keyword">new</span> Tone.FeedbackDelay(<span class="hljs-string">'16n'</span>, <span class="hljs-number">0.2</span>);
<span class="hljs-keyword">let</span> delay = Tone.context.createDelay(<span class="hljs-number">6.0</span>);
<span class="hljs-keyword">let</span> delayFade = Tone.context.createGain();
</pre>

<p>Here we initialize a variable called <code>equalizer</code>, which will be an array of <code>BiquadFilterNode</code>s. Each of their <code>gain</code>s is initialized to zero, which means that they will just pass the signal through without modifying it.</p>

<p>Next, we'll add these nodes into our audio graph. What we can do is simply connect them in series, so that the signal passes from one filter to the next. In Eno's systems diagram the graphic equalizer goes right after the synth, before the echo. So that's where we'll put it. The signal passes from the synth panners to the first filter in the equalizer. From the last filter in the equalizer we connect it to the echo:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs ">leftSynth.connect(leftPanner);
rightSynth.connect(rightPanner);
<span class="codeblock-highlight">leftPanner.connect(equalizer[<span class="hljs-number">0</span>]);
rightPanner.connect(equalizer[<span class="hljs-number">0</span>]);
equalizer.forEach((equalizerBand, index) =&gt; {
  <span class="hljs-keyword">if</span> (index &lt; equalizer.length - <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// Connect to next equalizer band</span>
    equalizerBand.connect(equalizer[index + <span class="hljs-number">1</span>]);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// This is the last band, connect it to the echo</span>
    equalizerBand.connect(echo);
  }
});</span>
echo.toMaster();
echo.connect(delay);
delay.connect(Tone.context.destination);
delay.connect(delayFade);
delayFade.connect(delay);
</pre>

<p>Here's the audio graph we have now:</p>

<figure class="diagram">
  <img src="./JavaScript Systems Music_files/webaudio-graph-discreet-full.png">
  <figcaption>The complete Discreet Music Web Audio graph: Panned synths, equalizer filters, echo, Frippertronics.</figcaption>
</figure>

<p>The system doesn't yet sound any different because none of the filters have nonzero gains. That's what we'll change next.</p>

<h4 id="building-the-equalizer-control-ui">Building the Equalizer Control UI</h4>

<p>We are still missing the "graphic" part of the graphic equalizer. What we're going to do is add to our HTML document a set of slider knobs, one for each frequency band in our equalizer. This will emulate the UI of an actual hardware graphic equalizer, which Eno would have been using.</p>

<p>Now, HTML5 has a <a href="http://www.html5tutorial.info/html5-range.php">standard range input</a>, which renders a slider for controlling a numeric value. Unfortunately this input leaves a lot to be desired, especially in terms of how to control its look and feel consistently across browsers. Because of this, we're going to bring in an additional library which makes things a lot easier. It's called <a href="http://refreshless.com/nouislider/">noUiSlider</a>.</p>

<p>Let's add this library to the project. We need some JavaScript as well as some CSS for it. While we're at it, let's add a container <code>&lt;div&gt;</code> into which we'll render our equalizer:</p>

<div class="codeblock-banner">index.html</div>

<pre class="hljs "><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="codeblock-highlight"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>
        <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="codeblock-highlight"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"eq"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.rawgit.com/mohayonao/web-audio-api-shim/master/build/web-audio-api-shim.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://tonejs.github.io/CDN/r7/Tone.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="codeblock-highlight"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.js"</span>&gt;</span></span><span class="undefined">
  </span><span class="codeblock-highlight"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"discreetmusic.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</pre>

<p>Switching to the JavaScript code, we'll add a new function called <code>initEqualizerUI</code>, which takes the container div and the array of filter nodes as arguments. We'll call it right at the end of the file, after we've started the system:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs ">Tone.Transport.start();
<span class="codeblock-highlight">initEqualizerUI(<span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'.eq'</span>), equalizer);</span>
</pre>

<p>In this function we're going to go through each frequency band in our equalizer and set up a knob UI for it. What we'd like to have for each knob is the following HTML structure - a wrapper <code>&lt;div&gt;</code> containing two elements: The slider element itself and a label element that displays what frequency we're controlling:</p>

<pre class="hljs "><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider-wrapper"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>1K<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</pre>

<p>Here's the function we need to generate and render this HTML structure for each frequency band:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initEqualizerUI</span>(<span class="hljs-params">container, equalizer</span>) </span>{
  equalizer.forEach(equalizerBand =&gt; {
    <span class="hljs-keyword">let</span> frequency = equalizerBand.frequency.value;

    <span class="hljs-keyword">let</span> wrapper = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
    <span class="hljs-keyword">let</span> slider = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
    <span class="hljs-keyword">let</span> label = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'label'</span>);

    wrapper.classList.add(<span class="hljs-string">'slider-wrapper'</span>);
    slider.classList.add(<span class="hljs-string">'slider'</span>);
    label.textContent = frequency &gt;= <span class="hljs-number">1000</span> ? <span class="hljs-string">`<span class="hljs-subst">${frequency / 1000}</span>K`</span> : frequency;

    wrapper.appendChild(slider);
    wrapper.appendChild(label);
    container.appendChild(wrapper);
  });
}
</pre>

<p>Now we can bring in the noUiSlider library and let it construct a range slider for each of the <code>&lt;div class="slider"&gt;&lt;/div&gt;</code> elements we're producing:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initEqualizerUI</span>(<span class="hljs-params">container, equalizer</span>) </span>{
  equalizer.forEach(equalizerBand =&gt; {
    <span class="hljs-keyword">let</span> frequency = equalizerBand.frequency.value;

    <span class="hljs-keyword">let</span> wrapper = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
    <span class="hljs-keyword">let</span> slider = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
    <span class="hljs-keyword">let</span> label = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'label'</span>);

    wrapper.classList.add(<span class="hljs-string">'slider-wrapper'</span>);
    slider.classList.add(<span class="hljs-string">'slider'</span>);
    label.textContent = frequency &gt;= <span class="hljs-number">1000</span> ? <span class="hljs-string">`<span class="hljs-subst">${frequency / 1000}</span>K`</span> : frequency;

<span class="codeblock-highlight">    noUiSlider.create(slider, {
      start: <span class="hljs-number">0</span>,                   <span class="hljs-comment">// The initial gain, 0dB</span>
      range: {min: <span class="hljs-number">-12</span>, max: <span class="hljs-number">12</span>}, <span class="hljs-comment">// The allowed gain range, -12dB..12dB</span>
      step: <span class="hljs-number">0.1</span>,                  <span class="hljs-comment">// Adjust the gain in 0.1dB increments</span>
      orientation: <span class="hljs-string">'vertical'</span>,    <span class="hljs-comment">// Render a vertical slider</span>
      direction: <span class="hljs-string">'rtl'</span>            <span class="hljs-comment">// -12dB goes at the bottom, 12dB at the top</span>
    });</span>

    wrapper.appendChild(slider);
    wrapper.appendChild(label);
    container.appendChild(wrapper);
  });
}
</pre>

<p>This will make the sliders visible, but we still need a bit of CSS to make them look better:</p>

<div class="codeblock-banner">index.html</div>

<pre class="hljs "><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.css"</span>&gt;</span>
<span class="codeblock-highlight">  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.eq</span> <span class="hljs-selector-class">.slider-wrapper</span> {
      <span class="hljs-comment">/* Float the wrappers so the sliders will render side by side */</span>
      <span class="hljs-attribute">float</span>: left;
    }
    <span class="hljs-selector-class">.eq</span> <span class="hljs-selector-class">.slider</span> {
      <span class="hljs-comment">/* Put some horizontal space around each slider */</span>
      <span class="hljs-attribute">margin</span>: auto <span class="hljs-number">5px</span>;
      <span class="hljs-comment">/* Set the slider heights */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">150px</span>;
    }
    <span class="hljs-comment">/* Make the frequency labels smaller and lighter */</span>
    <span class="hljs-selector-class">.eq</span> <span class="hljs-selector-tag">label</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#777</span>;
      <span class="hljs-attribute">display</span>: block;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.7em</span>;
      <span class="hljs-attribute">text-align</span>: center;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"eq"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://tonejs.github.io/CDN/r7/Tone.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"discreetmusic.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</pre>

<p>Now we have a perfectly acceptable looking graphic equalizer!</p>

<p><img src="./JavaScript Systems Music_files/discreet-graphic-equalizer.png">
There's a tiny problem with it though, which is that it doesn't actually work. Sliding the knobs has no effect. This is simply because we haven't connected the slider values to the <code>gain</code> attributes of the <code>BiquadFilterNode</code>s.</p>

<p>This is easily fixed. We just need to listen to the <code>update</code> event that noUiSlider sends when the slider's value changes. It gives us the slider value packaged into an array of strings (it's an array because the library supports multiple knobs per slider). We get the first value from the array and coerce it to a number to get the current gain number:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs "><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initEqualizerUI</span>(<span class="hljs-params">container, equalizer</span>) </span>{
  equalizer.forEach(equalizerBand =&gt; {
    <span class="hljs-keyword">let</span> frequency = equalizerBand.frequency.value;

    <span class="hljs-keyword">let</span> wrapper = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
    <span class="hljs-keyword">let</span> slider = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
    <span class="hljs-keyword">let</span> label = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'label'</span>);

    wrapper.classList.add(<span class="hljs-string">'slider-wrapper'</span>);
    slider.classList.add(<span class="hljs-string">'slider'</span>);
    label.textContent = frequency &gt;= <span class="hljs-number">1000</span> ? <span class="hljs-string">`<span class="hljs-subst">${frequency / 1000}</span>K`</span> : frequency;

    noUiSlider.create(slider, {
      start: <span class="hljs-number">0</span>,
      range: {min: <span class="hljs-number">-12</span>, max: <span class="hljs-number">12</span>},
      step: <span class="hljs-number">0.1</span>,
      direction: <span class="hljs-string">'rtl'</span>,
      orientation: <span class="hljs-string">'vertical'</span>,
    });
<span class="codeblock-highlight">    slider.noUiSlider.on(<span class="hljs-string">'update'</span>, ([value]) =&gt; {
      <span class="hljs-keyword">let</span> gain = +value;
    });</span>

    wrapper.appendChild(slider);
    wrapper.appendChild(label);
    container.appendChild(wrapper);
  });
}
</pre>

<p>Then we can just plop that value into the <code>gain</code> attribute of the filter node for this frequency:</p>

<div class="codeblock-banner">discreetmusic.js</div>

<pre class="hljs ">slider.noUiSlider.on(<span class="hljs-string">'update'</span>, ([value]) =&gt; {
  <span class="hljs-keyword">let</span> gain = +value;
  <span class="codeblock-highlight">equalizerBand.gain.value = gain;</span>
});
</pre>

<p>And finally we have a fully functional version of the Discreet Music system:</p>

<div class="player-area">
  <h4 id="discreet-music-demo">"Discreet Music"</h4>
  <div class="discreet-with-eq player">
    <div class="eq"><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>100</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>125</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>160</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>200</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>250</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>315</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>400</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>500</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>630</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>800</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>1K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>1.25K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>1.6K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>2K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>2.5K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>3.15K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>4K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>5K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>6.3K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>8K</label></div><div class="slider-wrapper"><div class="slider noUi-target noUi-rtl noUi-vertical noUi-background"><div class="noUi-base"><div class="noUi-origin" style="top: 50%;"><div class="noUi-handle noUi-handle-upper"></div></div></div></div><label>10K</label></div></div>
    <canvas class="frippertronics" width="650" height="650" style="cursor: pointer; width: 100%"></canvas>
  </div>
</div>

<p>You can adjust the knobs to alter the timbre of the system. You can get the most dramatic results by bringing the lower half of the bands all the way down and the upper half all the way up. This'll eliminate many of the fundamental pitches and highlight the overtone frequencies.</p>

<p>Do remember that because of the way we've set this system up, the immediate control you have on the music is limited: You're not controlling everything you hear, but just the sounds that are currently being generated from the synthesizer. Anything that's being repeated by Frippertronics isn't affected because it doesn't pass through the equalizer.</p>

<p>Also, as you listen to the music, there's no need to feel compelled to constantly fiddle with the equalizer. You can just adjust it from time to time and then let it be. This is what Eno did when he was recording Discreet Music, because he was busy:</p>

<blockquote cite="./JavaScript Systems Music_files/unk-78b.html">
  Once I got it going the phone started ringing, people started knocking on the door, and I was answering the phone and adjusting all this stuff as it ran. I almost made that without listening to it. It was really automatic music.
  <footer>Brian Eno, <a href="./JavaScript Systems Music_files/unk-78b.html">1978</a></footer>
</blockquote>

<h2 id="going-forward">Going Forward</h2>

<p>In this guide we've been reconstructing systems made by artists in the 1960s and 1970s using technology that's completely different from the original. The technical restrictions Reich and Eno faced – fixed, short tape durations and the absence of any kind of runtime computation – simply don't exist when working with Web Audio.</p>

<p>Making music with such artificial restrictions feels a bit funny, but then again, there's a certain elegance to the utter simplicity of these systems. Also, restrictions are often <em>good</em> when you're trying to create. Being overwhelmed with the technical possibilities of the platform can easily block you from coming up with anything interesting, and simply ruling out 80% of your options can unblock your creative flow. This is especially true when you're just getting started with the platform. As one of the masters of electronic music has put it:</p>

<blockquote cite="./JavaScript Systems Music_files/2756">
  When I first started using Max it was a bit intimidating, you'd get blank canvas syndrome, that moment of "what should I do? I could do anything!" Once I started to build stuff, narrow it down, reduce the capabilities, you start to get more ideas. It's all about narrowing down for me. There has to be a seed.
  <footer>Sean Booth of Autechre, <a href="./JavaScript Systems Music_files/2756">2016</a></footer>
</blockquote>

<p>There's certainly a similar quality to Web Audio: There's so much you can do that it can be intimidating. But if you limit your options, as we've done here by pretending we're working with the technologies of yesteryear, it suddenly becomes a lot easier to experiment.</p>

<p>But interesting as these pieces are to reverse engineer and reconstruct, I don't think they <em>really</em> make use of the unique possibilities we have with Web Audio. Whereas the systems constructed by Reich and Eno were physically constrained to their respective studios, we can simply and trivially just send the systems over to anyone in the world. It's just code and it runs in any web browser. There's at least a couple of possibilities this opens up that we haven't even touched on in this guide.</p>

<p>Firstly, the systems could be interactive, bringing the listener  in as an active participant instead of a passive receiver. Brian Eno himself has created such systems into his <a href="http://www.generativemusic.com/">generative music apps for iOS</a>, made in collaboration with <a href="http://www.peterchilvers.com/">Peter Chilvers</a>.</p>

<div class="vid">
  <iframe width="100%" height="315" src="./JavaScript Systems Music_files/lyg0BvAPd7E.html" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>Secondly, since we're working on the web platform, we are by definition <em>connected</em> to the outside world. Listeners could easily be connected to <em>each other</em>, making the interactive experience a social one as well. These systems could also potentially be connected to various servers and APIs around the world, providing possibilities for, say, music generated from real-time data sources.</p>

<p>Limited though these systems are, I hope they've given you an idea of the kinds of things we can do with Web Audio. They've certainly done so for me.</p>

<script src="https://cdn.rawgit.com/mohayonao/web-audio-api-shim/master/build/web-audio-api-shim.js"></script>

<script src="./JavaScript Systems Music_files/app.js"></script>

  </div>

  
  
    <div class="byoa-box narrow-content" style="margin: 5em auto">
      <a href="https://twitter.com/teropa"><img src="./JavaScript Systems Music_files/360c03aa3f802f18c43a5e1692de12fa"></a>
      <p style="margin-right: 150px"><a href="http://teropa.info/">Tero Parviainen</a> is an independent software developer and writer.</p>
      <p>
        <iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" class="twitter-follow-button twitter-follow-button-rendered" title="Twitter Follow Button" src="./JavaScript Systems Music_files/follow_button.4ca9f1d9cb5a373a2f7d0969f5b40084.en.html" style="position: static; visibility: visible; width: 231px; height: 28px;" data-screen-name="teropa"></iframe><script async="" src="./JavaScript Systems Music_files/widgets.js" charset="utf-8"></script>
        <style>iframe.twitter-follow-button { padding: 0 }</style>
      </p>
      <p style="margin-right: 150px">
        Tero is the author of two books: <a href="http://teropa.info/build-your-own-angular/">Build Your Own AngularJS</a> and <a href="https://www.packtpub.com/web-development/real-time-web-application-development-using-vertx-20">Real Time Web Application development using Vert.x 2.0</a>.
        He also likes to write in-depth articles on his blog, some examples of this being <a href="https://teropa.info/blog/2015/09/10/full-stack-redux-tutorial.html">The Full-Stack Redux Tutorial</a> and <a href="https://teropa.info/blog/2016/07/28/javascript-systems-music.html">JavaScript Systems Music</a>.
      </p>
    </div>
  
  

  <ul class="read_next narrow-content">
    <li><a href="http://teropa.info/blog/2016/05/19/things-that-excite-me-about-angular-2.html"><i class="icon-caret-left"></i> Things that Excite Me about Angular 2</a></li>
    <li><a href="http://teropa.info/blog/2016/08/04/sine-waves.html">Signals and Sine Waves <i class="icon-caret-right"></i></a></li>
  </ul>

  <div class="narrow-content">
    <div id="disqus_thread"></div>
  </div>
  <script type="text/javascript">
    var disqus_shortname = 'teropainfo';
    var disqus_config = function() {
      this.page.url = 'http://teropa.info/blog/2016/07/28/javascript-systems-music.html';
    };
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <div class="narrow-content">
    <noscript>Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;</noscript>
    <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</article>

<aside class="narrow-content">
  <ul class="tags">
    
      <li><a class="tiny button secondary round" href="http://teropa.info/blog/tags/javascript.html">javascript</a></li>
    
      <li><a class="tiny button secondary round" href="http://teropa.info/blog/tags/music.html">music</a></li>
    
      <li><a class="tiny button secondary round" href="http://teropa.info/blog/tags/webaudio.html">webaudio</a></li>
    
  </ul>
</aside>



    <!-- Footer -->
    <footer>
      <div class="row">
        <div class="small-12 large-3 columns">
          <p>© 2017 <a href="http://teropa.info/">Tero Parviainen</a></p>
        </div>
        <div class="small-12 large-3 columns">
          <p>Contact: <a href="https://twitter.com/teropa">@teropa</a> / <a href="mailto:tero@teropa.info">tero@teropa.info</a></p>
        </div>
    </div></footer>

    <!--[if lt IE 9]>
    <div id="ie-warning-overlay">
      <div id="ie-warning">
        <h1>Did you know that your copy of Internet Explorer is terribly out of date?</h1>
        <p>
          To get the best possible experience using our website, we recommend that you upgrade to the latest version or use another web browser.
          Any of the following will provide a superior experience, not only on this site, but across the web.
        </p>
        <p>Just click one of the icons below to get to the download page.</p>
        <ul>
          <li>
            <a href="http://microsoft.com/ie">
              <img alt="Download Internet Explorer" src="/images/browser_ie.gif" />
              <p>Internet Explorer</p>
            </a>
          </li>
          <li>
            <a href="http://mozilla.org/firefox">
              <img alt="Download Firefox" src="/images/browser_firefox.gif" />
              <p>Firefox</p>
            </a>
          </li>
          <li>
            <a href="http://google.com/chrome">
              <img alt="Download Chrome" src="/images/browser_chrome.gif" />
              <p>Google Chrome</p>
            </a>
          </li>
          <li>
            <a href="http://apple.com/safari">
              <img alt="Download Safari" src="/images/browser_safari.gif" />
              <p>Safari</p>
            </a>
          </li>
          <li>
            <a href="http://opera.com">
              <img alt="Download Opera" src="/images/browser_opera.gif" />
              <p>Opera</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <![endif]-->

    <iframe id="rufous-sandbox" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: none;" title="Twitter analytics iframe" src="./JavaScript Systems Music_files/saved_resource.html"></iframe></body></html>